<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE TOOLBAR SYSTEM "plugin.dtd">

<muclient>
<plugin
   name="Epic_Helper"
   author="Heracles"
   id="f9283746e5a6b7c8d9e0abcd"
   version="5.2"
   language="Lua"
   purpose="Epic Status Updates"
   save_state="y"
>
<description trim="y">
Usage: 
  epichelper help     - View the help manual
</description>
</plugin>

<aliases>
  <alias match="^epichelper help$" enabled="y" regexp="y" script="DisplayHelp"></alias>
  <alias match="^epichelper(| debug| status)$" enabled="y" regexp="y" script="ToggleLogic"></alias>
  <alias match="^epichelper leader ([\d\.]+) (\w+)$" enabled="y" regexp="y" script="SetLeader"></alias>
  <alias match="^epichelper update (.*)$" enabled="y" regexp="y" script="ManualStatus"></alias>
  <alias match="^epichelper ip(?: (\S+))?(?:\s+(.*))?$" enabled="y" regexp="y" script="HandleIPCommand"></alias>
</aliases>

<script>
<![CDATA[
local LEADER_PORT = 4050
local DATA_TYPE = 250 
local is_enabled = false 
local is_debug = false
local target_leader = "all"
local GMCP_HANDLER_ID = "3e7dedbe37e44942dd46d264"
local my_manual_ip = ""

local function lua_trim(s)
  if not s then return "" end
  return s:match("^%s*(.-)%s*$")
end

local function resolve_ip(host)
    local t = GetHostAddress(host)
    if type(t) == "table" and t[1] then
        return tostring(t[1])
    end
    return tostring(host)
end

function OnPluginInstall()
    OnPluginOpen()
end

function OnPluginOpen()
    is_enabled = (GetVariable("is_enabled") == "1")
    is_debug = (GetVariable("is_debug") == "1")
    target_leader = GetVariable("target_leader") or "all"
    my_manual_ip = GetVariable("my_manual_ip") or "Not Set"
    
    ColourNote("cyan", "", "Epic Helper ", "white", "", "loaded. Use ", "yellow", "", "epichelper help", "white", "", " for commands.")
    UpdateChatListener()
end

function UpdateChatListener()
    if is_enabled then
        ChatAcceptCalls(LEADER_PORT)
    else
        ChatStopAcceptingCalls()
    end
end

function DisplayHelp()
    local dash = string.rep("-", 60)
    Note(dash)
    ColourNote("cyan", "", " Epic_Helper ", "white", "", "v5.2 | Author: ", "yellow", "", "Heracles")
    Note(dash)
    ColourNote("yellow", "", "  epichelper status         ", "white", "", "- Show current status and peers")
    ColourNote("yellow", "", "  epichelper debug          ", "white", "", "- Toggle debug mode")
    ColourNote("yellow", "", "  epichelper update <msg>   ", "white", "", "- Send a manual status update")
    ColourNote("yellow", "", "  epichelper leader <IP> <N>", "white", "", "- Call/Set specific leader (Name N)")
    Note(dash)
    ColourNote("cyan", "", " IP COMMANDS:")
    ColourNote("yellow", "", "  epichelper ip <1.2.3.4>   ", "white", "", "- Set your IP manually")
    ColourNote("yellow", "", "  epichelper ip             ", "white", "", "- Check your saved IP")
    ColourNote("yellow", "", "  epichelper ip <chan>      ", "white", "", "- Share IP to a channel")
    ColourNote("yellow", "", "  epichelper ip <chan> <msg>", "white", "", "- Share IP with an extra note")
    ColourNote("yellow", "", "  epichelper ip <Peer> <ch> ", "white", "", "- Look up Peer IP and send to channel")
    Note(dash)
end

function HandleIPCommand(name, line, wildcards)
    local arg1 = lua_trim(wildcards[1])
    local extras = lua_trim(wildcards[2])
    local chat_list = GetChatList()

    -- 1. SETTING IP: If arg1 is an IP pattern
    if arg1:match("^%d+%.%d+%.%d+%.%d+$") then
        my_manual_ip = arg1
        SetVariable("my_manual_ip", my_manual_ip)
        SaveState()
        ColourNote("white", "blue", " [EPIC IP] ", "lime", "", " Saved: " .. my_manual_ip)
        return
    end

    -- 2. PEER LOOKUP: Check if arg1 matches a connected Peer name
    local found_peer_ip = nil
    if arg1 ~= "" and chat_list then
        for _, id in ipairs(chat_list) do
            if GetChatInfo(id, 1) == arg1 then
                found_peer_ip = resolve_ip(GetChatInfo(id, 2))
                break
            end
        end
    end

    if found_peer_ip then
        local msg = "[Epic Group] " .. arg1 .. " IP is " .. found_peer_ip
        ColourNote("cyan", "", ">> Found IP for " .. arg1 .. ": ", "white", "", found_peer_ip)
        if extras ~= "" then Execute(extras .. " " .. msg) end
        return
    end

    -- 3. BROADCASTING: If arg1 is a channel
    if arg1 ~= "" then
        if my_manual_ip == "Not Set" then
            ColourNote("red", "", "Error: Set your IP first using 'epichelper ip <your_ip>'")
            return
        end
        
        local out_msg = "[Epic Group] My IP is " .. my_manual_ip
        if extras ~= "" then
            out_msg = out_msg .. " - " .. extras
        end
        Execute(arg1 .. " " .. out_msg)
    else
        PrintMyIP(my_manual_ip)
    end
end

function PrintMyIP(ip)
    local col = (ip == "Not Set") and "red" or "yellow"
    ColourNote("white", "blue", " [EPIC IP] ", "cyan", "", " Currently saved IP: ", col, "", ip)
end

function ToggleLogic(name, line, wildcards)
    local arg = lua_trim(wildcards[1]):lower()
    if arg == "debug" then
        is_debug = not is_debug
        SetVariable("is_debug", is_debug and "1" or "0")
        ColourNote("white", "blue", " [DEBUG MODE: " .. (is_debug and "ON" or "OFF") .. "] ")
    elseif arg == "status" then
        ShowDashboard()
    else
        is_enabled = not is_enabled
        SetVariable("is_enabled", is_enabled and "1" or "0")
        ColourNote("white", is_enabled and "green" or "red", " [EPIC_HELPER: " .. (is_enabled and "ENABLED" or "DISABLED") .. "] ")
        UpdateChatListener()
    end
    SaveState()
end

function ShowDashboard()
    local dash = string.rep("=", 40)
    Note(dash)
    ColourNote("white", "", " EPIC_HELPER DASHBOARD")
    Note(dash)
    ColourNote("silver", "", " Status: ", is_enabled and "lime" or "red", "", is_enabled and "ACTIVE" or "INACTIVE")
    ColourNote("silver", "", " My IP:  ", "yellow", "", my_manual_ip)
    local chat_list = GetChatList() or {}
    ColourNote("silver", "", " Peers:  ", "white", "", #chat_list)
    Note(dash)
end

function SetLeader(name, line, wildcards)
    if not is_enabled then return end
    target_leader = wildcards[2]
    SetVariable("target_leader", target_leader)
    SaveState()
    ChatCall(wildcards[1], LEADER_PORT)
end

function OnPluginBroadcast(msg, id, name, text)
    if not is_enabled or id ~= GMCP_HANDLER_ID then return end
    if text == "comm.tick" then SendStatus("TICK_SYNC") end
end

function SendStatus(status_text)
    if not is_enabled then return end
    if target_leader == "all" then
        ChatGroup("EpicGroup", status_text, DATA_TYPE)
    else
        local chat_list = GetChatList()
        if chat_list then
            for _, id in ipairs(chat_list) do
                if GetChatInfo(id, 1) == target_leader then
                    ChatMessage(id, DATA_TYPE, status_text)
                end
            end
        end
    end
end

function ManualStatus(name, line, wildcards)
    if not is_enabled then return end
    SendStatus(wildcards[1])
end

function OnPluginChatConnect(id, name, ip)
    SetChatOption(id, "group", "EpicGroup")
    ColourNote("lime", "", ">> Connected to Peer: " .. name)
end

function OnPluginChatMessage(id, message_type, text)
    if message_type == DATA_TYPE then
        local sender = GetChatInfo(id, 1)
        if text ~= "TICK_SYNC" then
            ColourNote("cyan", "", "[EpicStatus] ", "white", "", sender .. ": " .. text)
        end
        return true 
    end
    return false 
end
]]>
</script>
</muclient>