<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Auto_Priest"
   author="Heracles"
   id="b8392f82c892e8a1d1234567"
   language="Lua"
   purpose="Automatic Priesting"
   save_state="y"
   version="3.9"
>
</plugin>

<triggers>
  <trigger
   enabled="y"
   match="^You are still recovering your Smiting abilities \(\d{2}:\d{2}\)\.$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>ExecuteImmediateSmiting()</send>
  </trigger>

  <trigger enabled="y" match="## You may now use shielding abilities." send_to="12" sequence="100">
    <send>QueuePriestSkill("cast 569", "Shielding")</send>
  </trigger>

  <trigger enabled="y" match="## You may now use Serenity." send_to="12" sequence="100">
    <send>
      Note("--> [Auto_Priest] Serenity trigger: Casting in 3 seconds (State Bypass).")
      DoAfterSpecial(3, 'Send("cast 572")', 12)
    </send>
  </trigger>

  <trigger enabled="y" match="## You may now use humility." send_to="12" sequence="100">
    <send>
      Note("--> [Auto_Priest] Humility trigger: Casting in 3 seconds (State Bypass).")
      DoAfterSpecial(3, 'Send("cast 602")', 12)
    </send>
  </trigger>

  <trigger enabled="y" match="You lost your concentration while trying to cast serenity." send_to="12" sequence="100">
    <send>
      Note("--> [Auto_Priest] Serenity failed: Retrying in 3 seconds...")
      DoAfterSpecial(3, 'Send("cast 572")', 12)
    </send>
  </trigger>

  <trigger enabled="y" match="You can't concentrate enough to cast 'holy shield'." send_to="12" sequence="100">
    <send>QueuePriestSkill("cast 569", "Shielding")</send>
  </trigger>

  <trigger enabled="y" match="You lost your concentration while trying to cast humility." send_to="12" sequence="100">
    <send>
      Note("--> [Auto_Priest] Humility failed: Retrying in 3 seconds...")
      DoAfterSpecial(3, 'Send("cast 602")', 12)
    </send>
  </trigger>
</triggers>

<script>
<![CDATA[
-- [2026-01-20] Note: 190 instinct gives 24%.
-- Per instructions: Do not remove unrelated code when making updates; brevity is not the goal.

local skill_queue = {}
local current_state = "3"
local last_state = "3"
local gmcp_id = "3e7dedbe37e44942dd46d264"

function OnPluginInstall()
    Note("--------------------------------------------------")
    Note("Auto_Priest Plugin by Heracles installed.")
    Note("Logic: v3.9 (Serenity/Humility 3s Bypass, Shield Queueing)")
    Note("--------------------------------------------------")
end

-- GMCP Broadcast Listener
function OnPluginBroadcast(msg, id, name, text)
    if id == gmcp_id and text == "char.status" then
        local res, gmcparg = CallPlugin(id, "gmcpval", "char.status")
        if res == 0 and gmcparg then
            ParseStateChange(gmcparg)
        end
    end
end

function ParseStateChange(data)
    local status_data = {}
    local f = loadstring("status_data = " .. data)
    if f then 
        f() 
        
        local new_state = tostring(status_data.state or "3")

        -- Track transition
        if new_state ~= current_state then
            last_state = current_state
            current_state = new_state
            
            -- RELEASE LOGIC for Holy Shield:
            -- If we just entered State 3 (Active) from ANY other state
            if current_state == "3" then
                if next(skill_queue) ~= nil then
                    Note("--> [Auto_Priest] State changed to 3. Releasing queued Shielding.")
                    ProcessPriestQueue()
                end
            end
        end
    end
end

function ExecuteImmediateSmiting()
    Send("cast 86")
end

function QueuePriestSkill(command, name)
    skill_queue[name] = command
    Note("--> [Auto_Priest] " .. name .. " queued. Will cast next time State is 3.")
end

function ProcessPriestQueue()
    local found = false
    for name, cmd in pairs(skill_queue) do
        Send(cmd)
        Note("--> [Auto_Priest] Releasing: " .. name)
        found = true
    end
    if found then 
        skill_queue = {} 
    end
end

function OnPluginEnable()
    Note("Auto_Priest enabled.")
end

function OnPluginDisable()
    Note("Auto_Priest disabled.")
end
]]>
</script>
</muclient>