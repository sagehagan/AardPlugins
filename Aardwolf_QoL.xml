<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Aardwolf_QoL"
   author="Heracles"
   id="61617264776f6c66516f4c78"
   language="Lua"
   purpose="Improving Aardwolf QoL"
   save_state="y"
   date_written="2026-01-24 15:20:00"
   requires="5.06"
   version="4.1"
   >
<description trim="y">
<![CDATA[
Aardwolf QoL Plugin
Author: Heracles

Features:
- Categorized UI (Universal & Thief)
- Bullet-Proof Gear Tracking: Monitors item strings to track equipment state.
- Precision Sanctuary Logic: Combat-only Aura protection with State 3 recovery.
- Thief Quickstab tracking, queuing, and combat-interruption recovery.
- Active GMCP State Monitoring with Fail-safe Parsing.
]]>
</description>

</plugin>

<triggers>
  <trigger
   enabled="y"
   match="^You are surrounded by a shimmering white aura of divine protection\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnSancCast"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^\{affon\}71.*$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnSancSpellOn"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^\{affoff\}71.*$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnSancSpellOff"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^(.+) begins floating around you\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnItemWorn"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^(.+) stops floating around you\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnItemRemoved"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^Your brilliant white aura of sanctuary shimmers and is gone\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnSancFall"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^You are already in sanctuary\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnAlreadyInSanc"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^You can\'t concentrate enough to cast \'sanctuary\'\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnSancConcentrationFail"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^## You may now use Quickstab abilities\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnQuickstabReset"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^Your weapon hand pulses with energy, ready to strike\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnQuickstabStart"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^You feel a little less focused on your backstab skills\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnQuickstabFade"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^You fail to focus on your backstab speed\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnQuickstabFail"
  >
  </trigger>

  <trigger
   enabled="y"
   match="^Not while you are fighting\!$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="OnQuickstabCombatFail"
  >
  </trigger>
</triggers>

<aliases>
  <alias match="qol help" enabled="y" send_to="12" sequence="100" script="ShowHelp"></alias>
  <alias match="^qol setfloat (.*)$" enabled="y" regexp="y" send_to="12" sequence="1" script="Set_Float_ID"></alias>
  <alias match="^qol setaura (.*)$" enabled="y" regexp="y" send_to="12" sequence="1" script="Set_Aura_ID"></alias>
  <alias match="qol status" enabled="y" send_to="12" sequence="100" script="CheckStatus"></alias>
  <alias match="qol debug" enabled="y" send_to="12" sequence="100" script="ToggleDebug"></alias>
</aliases>

<script>
<![CDATA[
require "json"

-- Configuration variables (Persisted)
local floatID = GetVariable("floatID") or ""
local floatName = GetVariable("floatName") or ""
local auraID = GetVariable("auraID") or ""
local auraName = GetVariable("auraName") or ""
local debugMode = (GetVariable("debugMode") == "1")

-- State variables (Volatile)
local currentState = 0
local sancSpellActive = false
local pendingSancAction = false
local quickstabQueued = false
local quickstabActive = false
local quickstabRecentlySent = false

-- Gear Tracking (Driven by Trigger strings)
local wearingFloat = false
local wearingAura = false

-- The ID of the Aardwolf GMCP Handler plugin
local GMCP_PLUGIN_ID = "3e7dedbe37e44942dd46d264"

-- UI Color Palette
local PRIMARY = "cyan"
local SECONDARY = "lightgrey"
local HIGHLIGHT = "yellow"
local ACCENT = "magenta"
local SUCCESS = "lime"
local WARN = "orange"
local DEBUG_CLR = "gray"

function OnPluginInstall()
    ColourNote(PRIMARY, "", "[Aardwolf QoL] ", SECONDARY, "", "Plugin by Heracles loaded. Tdy's new pup day is midnight eastern. Type ", HIGHLIGHT, "", "qol help", SECONDARY, "", " or ", HIGHLIGHT, "", "qol status", SECONDARY, "", " to begin.")
    UpdateStateFromGMCP()
end

function OnPluginSaveState()
    SetVariable("floatID", floatID)
    SetVariable("floatName", floatName)
    SetVariable("auraID", auraID)
    SetVariable("auraName", auraName)
    SetVariable("debugMode", debugMode and "1" or "0")
end

-------------------------------------------------------------------------
-- UI & Rendering
-------------------------------------------------------------------------

function ShowHelp()
    print("")
    ColourNote(PRIMARY, "", "================================================================================")
    ColourNote(HIGHLIGHT, "", " AARDWOLF QOL HELP - HERACLES ")
    ColourNote(PRIMARY, "", "================================================================================")
    
    ColourNote(ACCENT, "", "\n [ Universal Features ]")
    local u_cmds = {
        {cmd = "qol status",       desc = "Displays configuration, state, and buff status."},
        {cmd = "qol setfloat <id> <name>", desc = "Sets Float ID and Item String (e.g. a Mist of Blood)."},
        {cmd = "qol setaura <id> <name>",  desc = "Sets Aura ID and Item String (e.g. Aardwolf Aura of Sanctuary)."},
        {cmd = "qol help",         desc = "Displays this menu."}
    }
    for _, v in ipairs(u_cmds) do
        ColourTell(HIGHLIGHT, "", string.format("  %-25s", v.cmd))
        ColourNote(SECONDARY, "", " : " .. v.desc)
    end

    ColourNote(ACCENT, "", "\n [ Thief Features ]")
    ColourNote(SECONDARY, "", "  - Automatic Quickstab queuing for State 3 (Standing).")
    ColourNote(SECONDARY, "", "  - Skill Recovery: Automatically retries on focus failure.")
    ColourNote(SECONDARY, "", "  - Smart Re-queue: Triggers if QOL's quickstab is blocked by combat.")

    ColourNote(ACCENT, "", "\n [ System ]")
    ColourTell(HIGHLIGHT, "", string.format("  %-18s", "qol debug"))
    ColourNote(SECONDARY, "", " : Toggle verbose troubleshooting messages.")
    
    ColourNote(PRIMARY, "", "\n================================================================================")
    print("")
end

function CheckStatus()
    local state_color = (currentState == 3 or currentState == 8) and SUCCESS or WARN
    local qs_status_text = (quickstabQueued and "QUEUED" or (quickstabActive and "ACTIVE" or "Faded"))
    local qs_color = (quickstabQueued and HIGHLIGHT or (quickstabActive and SUCCESS or WARN))

    print("")
    ColourNote(PRIMARY, "", "--------------------------------------------------------------------------------")
    ColourNote(HIGHLIGHT, "", " Aardwolf QoL Status ")
    ColourNote(PRIMARY, "", "--------------------------------------------------------------------------------")
    
    ColourTell(SECONDARY, "", "  Current State:     ") ColourNote(state_color, "", tostring(currentState))
    
    ColourNote(ACCENT, "", "\n [ Universal Features: Sanctuary ]")
    ColourTell(SECONDARY, "", "  Spell Status:      ") ColourNote(sancSpellActive and SUCCESS or WARN, "", (sancSpellActive and "ON (Casted)" or "OFF (Missing)"))
    ColourTell(SECONDARY, "", "  Float Item:        ") ColourNote(floatID ~= "" and SUCCESS or WARN, "", string.format("%s (%s)", floatID, floatName))
    ColourTell(SECONDARY, "", "  Aura Item:         ") ColourNote(auraID ~= "" and SUCCESS or WARN, "", string.format("%s (%s)", auraID, auraName))
    ColourTell(SECONDARY, "", "  Current Gear:      ") ColourNote(HIGHLIGHT, "", (wearingFloat and "Wearing Float" or (wearingAura and "Wearing Aura" or "Other/Unknown")))
    ColourTell(SECONDARY, "", "  Pending Action:    ") ColourNote(pendingSancAction and HIGHLIGHT or SECONDARY, "", (pendingSancAction and "YES (Waiting for State 3)" or "None"))

    ColourNote(ACCENT, "", "\n [ Thief Features: Quickstab ]")
    ColourTell(SECONDARY, "", "  Quickstab Status:  ") ColourNote(qs_color, "", qs_status_text)

    ColourNote(ACCENT, "", "\n [ System ]")
    ColourTell(SECONDARY, "", "  Debug Mode:        ") ColourNote(debugMode and SUCCESS or SECONDARY, "", (debugMode and "ON" or "OFF"))
    
    ColourNote(PRIMARY, "", "--------------------------------------------------------------------------------")
    print("")
end

-------------------------------------------------------------------------
-- GMCP & Debug
-------------------------------------------------------------------------

function DebugPrint(msg)
    if debugMode then ColourNote(DEBUG_CLR, "", "[QOL DEBUG] " .. msg) end
end

function ToggleDebug()
    debugMode = not debugMode
    local status = debugMode and "ENABLED" or "DISABLED"
    ColourNote(PRIMARY, "", "[Aardwolf QoL] ", SECONDARY, "", "Debug messaging is now ", (debugMode and SUCCESS or WARN), "", status)
    SaveState()
end

function OnPluginBroadcast(msg, id, name, text)
    if id == GMCP_PLUGIN_ID and text:lower() == "char.status" then
        UpdateStateFromGMCP()
    end
end

function UpdateStateFromGMCP()
    local res, val = CallPlugin(GMCP_PLUGIN_ID, "gmcpval", "char.status")
    if res == 0 and val ~= "" then
        local new_state = string.match(val, '[Ss]tate%s*=%s*"(%d+)"')
        if not new_state then
            local f = loadstring("return " .. val)
            if f then
                local data = f()
                if data then new_state = data.state or data.State end
            end
        end
        if new_state then
            local old_state = currentState
            currentState = tonumber(new_state)
            if old_state ~= currentState then
                DebugPrint("State change: " .. old_state .. " -> " .. currentState)
                if currentState == 3 then
                    if pendingSancAction then ExecuteSanc() end
                    if quickstabQueued then ExecuteQuickstab() end
                end
            end
        end
    end
end

-------------------------------------------------------------------------
-- Gear String Tracking
-------------------------------------------------------------------------

function OnItemWorn(n, l, w)
    local itemName = string.lower(w[1])
    if itemName == string.lower(floatName) then
        wearingFloat = true; wearingAura = false
        DebugPrint("Detected: Float gear equipped.")
    elseif itemName == string.lower(auraName) then
        wearingAura = true; wearingFloat = false
        DebugPrint("Detected: Aura gear equipped.")
    end
end

function OnItemRemoved(n, l, w)
    local itemName = string.lower(w[1])
    if itemName == string.lower(floatName) then
        wearingFloat = false
        DebugPrint("Detected: Float gear removed.")
    elseif itemName == string.lower(auraName) then
        wearingAura = false
        DebugPrint("Detected: Aura gear removed.")
    end
end

-------------------------------------------------------------------------
-- Handlers: Universal (Sanctuary)
-------------------------------------------------------------------------

function Set_Float_ID(n, l, w)
    local id, name = string.match(w[1], "^(%S+)%s+(.*)$")
    if id and name then
        floatID, floatName = id, name
        ColourNote(SUCCESS, "", string.format("[Aardwolf QoL] Float Item set: %s (%s)", floatID, floatName))
        SaveState()
    else
        ColourNote(WARN, "", "[Aardwolf QoL] Usage: qol setfloat <id> <name>")
    end
end

function Set_Aura_ID(n, l, w)
    local id, name = string.match(w[1], "^(%S+)%s+(.*)$")
    if id and name then
        auraID, auraName = id, name
        ColourNote(SUCCESS, "", string.format("[Aardwolf QoL] Aura Item set: %s (%s)", auraID, auraName))
        SaveState()
    else
        ColourNote(WARN, "", "[Aardwolf QoL] Usage: qol setaura <id> <name>")
    end
end

function SmartWearFloat()
    if floatID ~= "" and not wearingFloat then Send("wear " .. floatID) end
end

function SmartWearAura()
    if auraID ~= "" and not wearingAura then Send("wear " .. auraID) end
end

function OnSancSpellOn() 
    sancSpellActive = true
    DebugPrint("Sanctuary Spell (71) confirmed ACTIVE.")
end

function OnSancSpellOff() 
    sancSpellActive = false
    DebugPrint("Sanctuary Spell (71) confirmed OFF.")
    
    -- ONLY intervene if we are in combat (State 8).
    -- If outside combat, another plugin handles the recast.
    if currentState == 8 then
        DebugPrint("Combat loss: Wearing Aura.")
        SmartWearAura()
        pendingSancAction = true
    else
        DebugPrint("Out-of-combat loss: Allowing external plugin to handle recast.")
        pendingSancAction = false
    end
end

function OnSancCast()
    sancSpellActive = true
    pendingSancAction = false
    DebugPrint("Sanctuary cast successful. Holding Float gear.")
end

function OnSancFall()
    if sancSpellActive then OnSancSpellOff() end
end

function OnAlreadyInSanc()
    -- Sync gear if spell is active; otherwise queue recast if missing spell ID.
    if sancSpellActive then
        pendingSancAction = false
        SmartWearFloat()
    else
        if currentState == 3 then ExecuteSanc() else pendingSancAction = true end
    end
end

function OnSancConcentrationFail()
    -- If cast fails (likely combat start), safeguard with Aura.
    DebugPrint("Concentration failed: Re-equipping Aura.")
    SmartWearAura()
    pendingSancAction = true
end

function ExecuteSanc()
    if currentState == 3 then
        DebugPrint("Transitioning to Float gear for Sanctuary cast.")
        SmartWearFloat()
        Send("cast 'sanctuary'")
        pendingSancAction = false
    else
        pendingSancAction = true
    end
end

-------------------------------------------------------------------------
-- Handlers: Thief
-------------------------------------------------------------------------

function OnQuickstabReset()
    if currentState == 3 then ExecuteQuickstab() else quickstabQueued = true end
end

function OnQuickstabFail()
    ExecuteQuickstab()
end

function OnQuickstabCombatFail()
    if quickstabRecentlySent and not quickstabActive then
        quickstabQueued = true; quickstabRecentlySent = false
    end
end

function OnQuickstabStart() quickstabActive, quickstabQueued, quickstabRecentlySent = true, false, false end
function OnQuickstabFade() quickstabActive = false end

function ExecuteQuickstab()
    quickstabRecentlySent, quickstabQueued = true, false
    Send("quickstab")
    DoAfterSpecial(2, 'quickstabRecentlySent = false', 12)
    ColourNote(SUCCESS, "", "[Aardwolf QoL] Executing: quickstab")
end

]]>
</script>

</muclient>