<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="Best_Little_Stabber"
   author="Heracles"
   id="b1e8d7a2f9c4e5d6a7b8c9d0"
   language="Lua"
   purpose="High-Fidelity Learning Tracker"
   save_state="y"
   version="22.3"
   >
</plugin>

<triggers>
  <trigger enabled="y" match="^\{roomchars\}$" regexp="y" script="room_start" omit_from_output="y" sequence="10" />
  <trigger enabled="y" match="^\{/roomchars\}$" regexp="y" script="room_end_trigger" omit_from_output="y" sequence="10" />
  <trigger enabled="n" group="room_capture" match="^(.*)$" regexp="y" script="process_mob_line" sequence="100" />
  <trigger enabled="y" match="^.*Your backstab .* \[.*\].*$" regexp="y" script="backstab_success" sequence="10" />
  <trigger enabled="y" match="^They aren't here\.$" regexp="y" script="backstab_fail_missing" sequence="10" />
  <trigger enabled="y" match="^(.*) has divine protection\.$" regexp="y" script="backstab_fail_protected" sequence="1" />
</triggers>

<aliases>
  <alias match="^bls$" enabled="y" regexp="y" script="bls_toggle" />
  <alias match="^bls auto$" enabled="y" regexp="y" script="bls_cmd_auto" />
  <alias match="^bls all$" enabled="y" regexp="y" script="bls_all_handler" />
  <alias match="^bls stop$" enabled="y" regexp="y" script="bls_stop" />
  <alias match="^bls (help|status|debug)$" enabled="y" regexp="y" script="bls_control" />
  <alias match="^bls list(?: (?&lt;filter&gt;.*))?$" enabled="y" regexp="y" script="display_list" />
  <alias match="^bls set (?&lt;id&gt;\d+) (?&lt;key&gt;\w+)$" enabled="y" regexp="y" script="bls_set_keyword" />
  <alias match="^bls (ignore|unignore) (?&lt;id&gt;\d+)$" enabled="y" regexp="y" script="bls_ignore_toggle" />
  <alias match="^bls remove (?&lt;id&gt;\d+)$" enabled="y" regexp="y" script="bls_remove_entry" />
  <alias match="^bls wipe( confirm)?$" enabled="y" regexp="y" script="bls_wipe_handler" />
  <alias match="^bls rem (?<area>.*)$" enabled="y" regexp="y" script="bls_remove_area" />
<alias match="^bls find (.*)$" enabled="y" regexp="y" script="bls_find_long" />
</aliases>

<script>
<![CDATA[
require "gmcphelper"
local sqlite3 = require "sqlite3"
local db_path = GetInfo(6) .. "BestLittleStabber.db"
local db = nil

local function ColoursToAnsi(text)
    return (text:gsub("@([RDGYBMCPWrdgybmcpw])", function(code)
        local colors = {
            R = "\27[1;31m", G = "\27[1;32m", Y = "\27[1;33m", B = "\27[1;34m",
            M = "\27[1;35m", C = "\27[1;36m", P = "\27[1;35m", W = "\27[1;37m",
            r = "\27[0;31m", g = "\27[0;32m", y = "\27[0;33m", b = "\27[0;34m",
            m = "\27[0;35m", c = "\27[0;36m", p = "\27[0;35m", w = "\27[0;37m"
        }
        return colors[code] or "@" .. code
    end):gsub("@x(%d+)", function(code)
        return "\27[38;5;" .. code .. "m"
    end))
end

gmcpdata = { char = { status = { state = "3" } }, room = { info = {} } }
plugin_enabled = (GetVariable("enabled") ~= "0")
debug_mode = (GetVariable("debug_mode") == "1")

local state = {
    active_command = nil, 
    waiting_for_hit = false,
    pending_look = false,
    target_queue = {},
    target_metadata = {},
    database_cache = {},  -- ADD THIS LINE
    raw_buffer = "",
    last_keyword_index = 1,
    trust_queue = true,
    last_attempted_keyword = nil,
    swarm_total = 0,
    swarm_hits = 0,
    swarm_misses = 0,
    word_index = 1 -- Tracks which word of the long name we are trying
}

local noise_words = {
    ["a"]=true, ["an"]=true, ["the"]=true, ["this"]=true, ["that"]=true,
    ["and"]=true, ["but"]=true, ["or"]=true, ["for"]=true, ["nor"]=true, ["so"]=true, ["yet"]=true,
    ["in"]=true, ["on"]=true, ["at"]=true, ["to"]=true, ["with"]=true,
    ["it"]=true, ["is"]=true, ["was"]=true, ["are"]=true, ["be"]=true, ["i"]=true, ["you"]=true, ["he"]=true, ["she"]=true
}

function OnPluginInstall()
    init_database()
    AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wV22.3 Loaded. [Help/Status: @x226bls help @w| @x226bls status@w]"))
end

function init_database()
    db = sqlite3.open(db_path)
    if not db then return end
    db:exec([[CREATE TABLE IF NOT EXISTS mob_keywords (
        id INTEGER PRIMARY KEY AUTOINCREMENT, 
        long_name TEXT, 
        keyword TEXT, 
        area TEXT, 
        ignored INTEGER DEFAULT 0, 
        UNIQUE(long_name, area)
    );]])
end

function debug_log(cat, msg)
    if debug_mode then 
        local prefix = "@x196[@x242BLS Debug@x196] @x051" .. string.format("%-12s", cat) .. " @w: "
        AnsiNote(ColoursToAnsi(prefix .. tostring(msg)))
    end
end

function OnPluginBroadcast(msg, id, name, text)
        if (id == '3e7dedbe37e44942dd46d264') then
            local area = gmcp("room.info.zone") or "Global"
            local current_state = tostring(gmcp("char.status.state") or "0")

        -- Debug messaging for event tracking
        if GetVariable("debug") == "1" then
            debug_log("GMCP", "Data synchronized: room and char objects updated.")
        end

        local current_state = tostring(gmcpdata.char.status.state)

        if current_state == "3" and state.swarm_total > 0 then
            if (state.swarm_hits + state.swarm_misses) >= state.swarm_total then
                debug_log("Swarm", "@GQueue Cleared! @wTotal: " .. state.swarm_total)
                BroadcastPlugin(100, "ROOM_CLEAR")
                state.swarm_total, state.swarm_hits, state.swarm_misses = 0, 0, 0
            end
        end

        if state.pending_look and current_state == "3" then
            state.pending_look = false
            Send("look")
        end
    end
end

function bls_control(name, line, wildcards)
    local cmd = wildcards[1]
    if cmd == "debug" then
        debug_mode = not debug_mode
        SetVariable("debug_mode", debug_mode and "1" or "0")
        AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wDebug: " .. (debug_mode and "@GEnabled" or "@REnabled")))
    elseif cmd == "status" then
        display_status()
    elseif cmd == "help" then
        AnsiNote(ColoursToAnsi("\n@x196[@x242BLS@x196] @wHelp Menu - V22.6"))
        
        local function help_line(cmd, desc)
            AnsiNote(ColoursToAnsi(string.format("@x226  %-18s @x242| @w%s", cmd, desc)))
        end

        -- Automation Section
        AnsiNote(ColoursToAnsi("@x242  Automation\n  " .. string.rep("-", 50)))
        help_line("bls auto", "Attacks all targets one by one looking for keywords")
        help_line("bls all", "Stabs all targets if keywords known - If not, starts Auto.")
        help_line("bls stop", "Halt current automation")

        -- Database Section
        AnsiNote(ColoursToAnsi("\n@x242  Database Management\n  " .. string.rep("-", 50)))
        help_line("bls list <zone>", "Display mob DB - Zone Filter Optional")
        help_line("bls find <text>", "Search database for a mob long name") -- Added search command
        help_line("bls set <id> <key>", "Set manual keyword for ID")
        help_line("bls ignore <id>", "Set ID to Ignored [I]")
        help_line("bls unignore <id>", "Return ID to active [K/L]")
        help_line("bls remove <id>", "Delete specific entry by ID")
        help_line("bls rem <area>", "Delete all entries for an area")
        help_line("bls wipe confirm", "Clear entire database - No Take Backs")

        -- System Section
        AnsiNote(ColoursToAnsi("\n@x242  System\n  " .. string.rep("-", 50)))
        help_line("bls", "Toggle plugin ON/OFF")
        help_line("bls status", "Show current plugin state")
        help_line("bls debug", "Toggle debug messaging")
        AnsiNote("")
    end
end

function display_status()
    AnsiNote(ColoursToAnsi("@x051.--------------------------------------."))
    AnsiNote(ColoursToAnsi("@x051| @x242         BLS System Status          @x051|"))
    AnsiNote(ColoursToAnsi("@x051|--------------------------------------|"))
    AnsiNote(ColoursToAnsi("@x051| @wPower: " .. (plugin_enabled and "@G[ONLINE] " or "@R[OFFLINE]") .. " @w| Debug: " .. (debug_mode and "@G[ON] " or "@R[OFF]") .. " @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @wMode:  @x226" .. string.format("%-26s", (state.active_command or "Idle")) .. " @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @wState: @x226" .. string.format("%-26s", (gmcpdata.char.status.state or "Unknown")) .. " @x051|"))
    AnsiNote(ColoursToAnsi("@x051'--------------------------------------'"))
end

function display_help()
    AnsiNote(ColoursToAnsi("@x051.--------------------------------------."))
    AnsiNote(ColoursToAnsi("@x051| @x242          BLS Help Menu             @x051|"))
    AnsiNote(ColoursToAnsi("@x051|--------------------------------------|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls auto        @w: Start discovery loop @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls all         @w: Stab known targets   @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls list <arg>  @w: Filter by Name/Area  @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls list queue  @w: Show current room targets @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls set # key   @w: Fix keyword          @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls ignore #    @w: Hide mob from queue  @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls stop        @w: Halt all sequences   @x051|"))
    AnsiNote(ColoursToAnsi("@x051| @x226bls debug       @w: Toggle debug mode    @x051|"))
    AnsiNote(ColoursToAnsi("@x051'--------------------------------------'"))
end

function bls_toggle()
    plugin_enabled = not plugin_enabled
    SetVariable("enabled", plugin_enabled and "1" or "0")
    if not plugin_enabled then bls_stop() end
    local status = plugin_enabled and "@GEnabled" or "@RDisabled"
    AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wMaster Power: " .. status))
end

function bls_cmd_auto()
    if not plugin_enabled then return end
    state.active_command = "auto"
    Send("look")
end

function bls_all_handler()
    if not plugin_enabled then return end
    state.active_command = "all"
    Send("look")
end

function bls_stop()
    state.active_command = nil
    state.waiting_for_hit = false
    state.pending_look = false
    state.swarm_total, state.swarm_hits, state.swarm_misses = 0, 0, 0
    debug_log("Sequence", "@RSTOPPED.")
end

function room_start()
    state.target_queue = {}
    state.target_metadata = {}
    state.raw_buffer = ""
    state.trust_queue = true
    EnableTriggerGroup("room_capture", true)
    state.room_has_unknown = false
    state.room_trusted = true
end

function process_mob_line(name, line, wildcards)
    local text = wildcards[1]
    text = text:gsub("%s*%[.-%]", "")
    if text:find("%(Player%)") or text:find("%(P%)") or text:find("%(Charmed%)") or text:find("%(C%)") or text:find("%(Angry%)") or text:find("%(Archaeology%)") or text:find("is fighting") or text:find("KILL YOU!")then return end

    if text:match("^%s*%(") or text:match("^%s*[A-Z]") then
        if state.raw_buffer ~= "" then handle_captured_mob(trim(state.raw_buffer)) end
        state.raw_buffer = text
    else 
        state.raw_buffer = state.raw_buffer .. " " .. trim(text) 
    end

    if text:match("[%.;!]%s*$") then 
        handle_captured_mob(trim(state.raw_buffer))
        state.raw_buffer = "" 
    end
end

function handle_captured_mob(mob_raw)
    local mob_long = trim(mob_raw:gsub("%b()", ""))
    if mob_long == "" or mob_long:len() < 3 then return end
    
    local area = gmcp("room.info.zone") or "Global"
    local keyword, ignored, exists = "", 0, false
    
    local stmt = db:prepare("SELECT keyword, ignored FROM mob_keywords WHERE long_name = ? AND area = ?")
    if stmt then
        stmt:bind_values(mob_long, area)
        if stmt:step() == sqlite3.ROW then
            local row = stmt:get_values()
            keyword, ignored = row[1] or "", row[2] or 0
            exists = true
        else
            db:exec(string.format("INSERT INTO mob_keywords (long_name, area, keyword) VALUES (%s, %s, '')", fixsql(mob_long), fixsql(area)))
        end
        stmt:finalize()
    end

    local status_label = "@rUnknown"
    if exists then status_label = (keyword ~= "") and "@GKnown  " or "@YLearning" end
    if ignored == 1 then status_label = "@RIgnored " end

    debug_log("Target", string.format("%s | Key: @x226%-10s @w| %s", status_label, (keyword ~= "" and keyword or "???"), mob_long))

    if ignored == 1 then return end
    table.insert(state.target_queue, mob_long)
    table.insert(state.target_metadata, { keyword = keyword })
    if keyword == "" then state.trust_queue = false end
end

function room_end_trigger()
    EnableTriggerGroup("room_capture", false)
    
    if state.raw_buffer ~= "" then 
        handle_captured_mob(trim(state.raw_buffer)) 
        state.raw_buffer = ""
    end
    
    local final_count = #state.target_queue
    local trust_status = (final_count > 0) and (state.trust_queue and "@G[TRUSTED]" or "@Y[UNTRUSTED]") or "@R[EMPTY]"

    local debug_string = "@wTotal: @Y" .. tostring(final_count) .. " @wtargets. Room Status: " .. trust_status
    debug_log("Queue", debug_string)

    if not plugin_enabled or not state.active_command then return end
    if final_count == 0 then
        state.active_command = nil
        return
    end

    if state.active_command == "all" and not state.trust_queue then
        debug_log("Action", "@RQueue untrusted. Falling back to AUTO.")
        state.active_command = "auto"
    end
    
    if state.active_command == "all" then bls_execute_swarm()
    elseif state.active_command == "auto" then bls_execute_next() end
end

function bls_execute_swarm()
    local counts = {}
    local commands = {}
    state.swarm_hits, state.swarm_misses = 0, 0
    
    for _, meta in ipairs(state.target_metadata) do
        if meta.keyword ~= "" then
            counts[meta.keyword] = (counts[meta.keyword] or 0) + 1
            table.insert(commands, { key = meta.keyword, index = counts[meta.keyword] })
        end
    end
    
    state.swarm_total = #commands
    if state.swarm_total == 0 then 
        state.active_command = nil 
        return 
    end

    for i = #commands, 1, -1 do
        local cmd = commands[i]
        local prefix = (cmd.index > 1) and (cmd.index .. ".") or ""
        Send("backstab " .. prefix .. cmd.key)
    end
    state.active_command = nil
end

function bls_execute_next()
    if #state.target_queue == 0 then 
        state.active_command = nil
        return 
    end
    local mob_long, meta = state.target_queue[1], state.target_metadata[1]
    local keyword = meta.keyword
    if keyword == "" then
        local words = {}
        for w in mob_long:gmatch("%S+") do
            local clean = w:gsub("^%p+", ""):gsub("%p+$", ""):gsub("'s$", ""):lower()
            if not noise_words[clean] and clean ~= "" then table.insert(words, clean) end
        end
        if state.last_keyword_index > #words then
            table.remove(state.target_queue, 1)
            table.remove(state.target_metadata, 1)
            state.last_keyword_index = 1
            bls_execute_next()
            return
        end
        keyword = words[state.last_keyword_index]
        state.last_attempted_keyword = keyword
    end
    state.waiting_for_hit = true
    Send("backstab " .. keyword)
end

function backstab_success()
    if state.swarm_total > 0 then state.swarm_hits = state.swarm_hits + 1 end
    if not state.active_command then return end
    state.waiting_for_hit = false
    if state.last_attempted_keyword then
        debug_log("Result", "@GSUCCESS @w- Logged: @Y" .. state.last_attempted_keyword)
        local mob_long = state.target_queue[1]
        local area = gmcp("room.info.zone") or "Global"
        db:exec(string.format("UPDATE mob_keywords SET keyword = %s WHERE long_name = %s AND area = %s", fixsql(state.last_attempted_keyword), fixsql(mob_long), fixsql(area)))
        state.last_attempted_keyword, state.last_keyword_index = nil, 1
    end
    state.pending_look = true
end

function backstab_fail_missing()
    if state.swarm_total > 0 then state.swarm_misses = state.swarm_misses + 1 end
    if not state.active_command then return end
    debug_log("Result", "@RFAIL (Target Missing)")
    state.waiting_for_hit = false
    if state.last_attempted_keyword then
        state.last_keyword_index = state.last_keyword_index + 1
        state.last_attempted_keyword = nil
        bls_execute_next()
    end
end

function backstab_fail_protected(name, line, wildcards)
    if not state.active_command then return end
    debug_log("Result", "@RFAIL (Protected)")
    db:exec(string.format("UPDATE mob_keywords SET ignored = 1 WHERE long_name LIKE %s", fixsql("%" .. wildcards[1] .. "%")))
    state.waiting_for_hit, state.active_command = false, nil
end

function display_list(name, line, wildcards)
    local filter = wildcards.filter or ""
    local query = "SELECT * FROM mob_keywords"
    if filter ~= "" then
        query = query .. " WHERE long_name LIKE " .. fixsql("%" .. filter .. "%") .. " OR area LIKE " .. fixsql("%" .. filter .. "%")
    end
    -- Sort strictly by ID as requested
    query = query .. " ORDER BY id ASC"

    AnsiNote(ColoursToAnsi("\n@x196[@x242BLS@x196] @wTarget Database"))
    
    -- Headers with internal bars only
    local header = string.format("@x242  %-4s | %-15s | %-12s | %-3s | %-s", "ID", "Area", "Keyword", "S", "Long Name")
    AnsiNote(ColoursToAnsi(header))
    
    -- Header underline (dashes) - calculating length based on header string
    AnsiNote(ColoursToAnsi("@x242  " .. string.rep("-", 65)))

    for row in db:nrows(query) do
        local status = "@x034[K]" -- Known (Green)
        if row.ignored == 1 then
            status = "@x160[I]" -- Ignored (Red)
        elseif row.keyword == "" then
            status = "@x226[L]" -- Learning (Yellow)
        end

        local area = (row.area:len() > 15) and (row.area:sub(1,12) .. "...") or row.area
        -- Rows with internal bars only
        local line = string.format("@x242  %-4d | @w%-15s @x242| @Y%-12s @x242| %s @x242| @w%s", 
            row.id, area, (row.keyword == "" and "???" or row.keyword), status, row.long_name)
        AnsiNote(ColoursToAnsi(line))
    end
    
    AnsiNote(ColoursToAnsi("\n@x242Status: @x034[K]@w=Known @x226[L]@w=Learning @x160[I]@w=Ignore\n"))
end

function bls_set_keyword(name, line, wildcards)
    db:exec(string.format("UPDATE mob_keywords SET keyword = %s WHERE id = %d", fixsql(wildcards.key), tonumber(wildcards.id)))
    AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wID " .. wildcards.id .. " updated: @Y" .. wildcards.key))
end

function bls_ignore_toggle(name, line, wildcards)
    local val = (wildcards[1] == "ignore") and 1 or 0
    db:exec(string.format("UPDATE mob_keywords SET ignored = %d WHERE id = %d", val, tonumber(wildcards.id)))
    local status = (val == 1) and "@RIgnored" or "@GActive"
    AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wID " .. wildcards.id .. " set to: " .. status))
end

function bls_remove_entry(name, line, wildcards)
    db:exec(string.format("DELETE FROM mob_keywords WHERE id = %d", tonumber(wildcards.id)))
    AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wEntry " .. wildcards.id .. " removed."))
end

function bls_wipe_handler(name, line, wildcards)
    if wildcards[1] == " confirm" then
        -- Clear the data
        db:exec("DELETE FROM mob_keywords")
        -- Reset the auto-increment counter
        db:exec("DELETE FROM sqlite_sequence WHERE name='mob_keywords'")
        
        AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @RDatabase purged and ID counter reset."))
        
        -- Robust debug messaging
        if GetVariable("debug") == "1" then
            debug_log("Database", "Table 'mob_keywords' cleared and sequence reset to 1.")
        end
    else
        AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wUse '@Ybls wipe confirm@w' to clear database."))
    end
end

    function fixsql(s) return "'" .. (tostring(s):gsub("'", "''")) .. "'" end
    function trim(s) return s:match("^%s*(.-)%s*$") end

    function bls_remove_area(name, line, wildcards)
        local area = wildcards.area
        local res = db:exec(string.format("DELETE FROM mob_keywords WHERE area LIKE %s", fixsql("%" .. area .. "%")))
        if res == sqlite3.OK then
            AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @wAll entries for area matching '@Y" .. area .. "@w' have been removed."))
        else
            AnsiNote(ColoursToAnsi("@x196[@x242BLS@x196] @RError removing area entries."))
        end
    end

function bls_find_long(name, line, wildcards)
    local filter = wildcards[1] or ""
    
    -- Exact same query logic as display_list, but focused on the search term
    local query = "SELECT * FROM mob_keywords WHERE long_name LIKE " .. fixsql("%" .. filter .. "%") .. " ORDER BY id ASC"

    AnsiNote(ColoursToAnsi("\n@x196[@x242BLS@x196] @wSearch Results: '@Y" .. filter .. "@w'"))
    
    -- Headers: Exact match to your display_list function
    local header = string.format("@x242  %-4s | %-15s | %-12s | %-3s | %-s", "ID", "Area", "Keyword", "S", "Long Name")
    AnsiNote(ColoursToAnsi(header))
    
    -- Header underline (65 dashes)
    AnsiNote(ColoursToAnsi("@x242  " .. string.rep("-", 65)))

    local count = 0
    for row in db:nrows(query) do
        count = count + 1
        local status = "@x034[K]" -- Known (Green)
        if row.ignored == 1 then
            status = "@x160[I]" -- Ignored (Red)
        elseif row.keyword == "" then
            status = "@x226[L]" -- Learning (Yellow)
        end

        -- Area truncation logic
        local area = (row.area:len() > 15) and (row.area:sub(1,12) .. "...") or row.area
        
        -- Row formatting: Exact match to your display_list function
        local line_out = string.format("@x242  %-4d | @w%-15s @x242| @Y%-12s @x242| %s @x242| @w%s", 
            row.id, area, (row.keyword == "" and "???" or row.keyword), status, row.long_name)
        AnsiNote(ColoursToAnsi(line_out))
    end
    
    if count == 0 then
        AnsiNote(ColoursToAnsi("@x242  No matches found for: @Y" .. filter))
    else
        -- Status Footer
        AnsiNote(ColoursToAnsi("\n@x242Status: @x034[K]@w=Known @x226[L]@w=Learning @x160[I]@w=Ignore\n"))
    end
end

]]>
</script>
</muclient>