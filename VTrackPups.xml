<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- MuClient version 5.06-pre -->

<!-- Plugin "VTrack" generated by Plugin Wizard -->

<muclient>
<plugin
  name="VTrackPups"
  author="Valour"
  id="87de24dc0b84faae4729ffb8"
  language="Lua"
  purpose="Pup Stats"
  save_state="y"
  date_written="2018-12-26 15:44:07"
  requires="5.06"
  version="1.0"
  >

  <description trim="n">
    <![CDATA[

      VTrackPups Commands


      vt chan <channel>               - Sets Reporting Channel.  See below for non-standard channel options
                                        - print: Prints to main output window (vt chan print)
                                        - printcomm: Prints to main commlog window or tab 1 (vt chan printcomm)
                                        - vtrack: Prints to tab named "VTrack" if exists. (vt chan vtrack)

      vt debug                        - Enables/Disables Debug Mode.  Will spam you with debug notes.


]]>
  </description>

</plugin>

<timers>
  <timer
    name="tmToday"
    enabled="y"
    second="1"
    script="TmrCheckToday"
    >
  </timer>
</timers>

<aliases>
  <alias
    match="^ *rp *test *$"
    script="CmdTest"
    enabled="y"
    regexp="y"
    sequence="100"
    >
  </alias>
  <alias
    match="^vt chan (.+)$"
    script="tracker_settings"
    enabled="y"
    regexp="y"
    sequence="100"
    >
  </alias>
  <alias
    script="SetDebug"
    match="^vt debug$"
    enabled="y"
    regexp="y"
    sequence="100"
    ignore_case="y"
    >
  </alias>
  <alias
    match="^vtpups help$"
    enabled="y"
    regexp="y"
    send_to="12"
    sequence="100"
    script="vt_help"
  >
  </alias>
</aliases>

<triggers>
  <trigger
    enabled="y"
    match="Congratulations, *. You have increased your powerups to *."
    name="pup"
    script="TrgPup"
    sequence="100"
  >
  </trigger>
  <trigger
    enabled="y"
    match="You gain * trains."
    name="pupgains"
    script="TrgPupGains"
    group="trgLevelInfo"
    sequence="100"
  >
  </trigger>
  <trigger
    enabled="y"
    regexp="y"
    match="^Lucky! You gain an extra (\d) training sessions?!$"
    name="bonusgains"
    script="TrgPupGains"
    group="trgLevelInfo"
    sequence="100"
  >
  </trigger>
  <trigger
    enabled="y"
    regexp="y"
    match="^You gain (.*) extra(?: trains)? daily blessing bonus.$"
    name="blessingtrains"
    script="TrgPupGains"
    group="trgLevelInfo"
    sequence="100"
  >
  </trigger>

  <trigger
    enabled="y"
    regexp="y"
    match="^$"
    name="trgFinish"
    script="TrgFinish"
    sequence="100"
  >
  </trigger>



  <trigger
    enabled="y"
    regexp="y"
    match="^You get ([\d,]+) gold coins (.+) corpse of (.+)\.$"
    name="trgMobGold"
    script="TrgGold"
    sequence="100"
  >
  </trigger>
  <!-- Some Rare Fish Scales crumbles into 4,000 gold pieces. -->
  <trigger
    enabled="y"
    regexp="y"
    match="^.*? crumbles into ([\d,]+) gold pieces\.$"
    name="trgCrubleGold"
    script="TrgGold"
    sequence="100"
  >
  </trigger>
  <trigger
    enabled="y"
    regexp="y"
    match="^\w+ shares ([\d,]+) gold (?:coin|coins) with [\d\w ]+\. Your share is ([\d,]+) gold\.$"
    name="trgSplitGoldOther"
    script="TrgGold"
    sequence="100"
  >
  </trigger>
  <trigger
    enabled="y"
    regexp="y"
    match="^You share ([\d,]+) gold (?:coin|coins) with [\d\w ]+\. Your share is ([\d,]+) gold\.$"
    name="trgSplitGoldMine"
    script="TrgGold"
    sequence="100"
  >
  </trigger>
  <trigger
    enabled="y"
    regexp="y"
    match="^You are taxed ([\d,]+) gold (?:coin|coins) by your clan.$"
    name="trgClanTax"
    script="TrgGold"
    sequence="100"
  >
  </trigger>


  <trigger
    enabled="y"
    regexp="y"
    match="^You receive (\d+)(?:\+(\d+))?(?:\+(\d+))? experience points?\.$"
    name="trgMobExp"
    script="TrgExp"
    sequence="100"
  >
  </trigger>

  <trigger
    enabled="y"
    regexp="y"
    match="^You receive (\d+) bonus experience points? from your daily blessing\.$"
    name="trgBlessingExp"
    script="TrgExp"
    sequence="99"
  >
  </trigger>

  <trigger
    enabled="y"
    regexp="y"
    match="^You receive (\d+) bonus experience points *"
    name="trgBonusExp"
    script="TrgExp"
    sequence="100"
  >
  </trigger>

  <trigger
    enabled="y"
    regexp="y"
    match="^You receive (\d+) 'rare kill' experience bonus."
    name="trgRareExp"
    script="TrgExp"
    sequence="100"
  >
  </trigger>
</triggers>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<script>
<![CDATA[

-- You raise a level! You are now level 26.
-- You gain 19 hit points, 25 mana, 17 moves, 9 practices and 2 trains.
-- Lucky! You gain an extra 1 training session!
-- You gain a bonus Intelligence point!
-- You gain a bonus Dexterity point!


dofile(GetInfo(56) .. GetInfo(60) .. "aardwolf_colors.lua")

-- require 'gmcphelper'
require 'tprint'
require "commas"
-- require "serialize"

-------------------------------------------------------------------------------
-- Variables
-------------------------------------------------------------------------------

  history = {}
  maxHistory = 0
  newPup = {
    trains     = 0,
    bonus      = 0,
    startTime  = GetInfo(304),
    finishTime = 0,
    pupTime    = 0,
    kills      = 0,
    exp        = 0,
    gold       = 0
  }

  today = {
    date   = GetVariable("today_date") or os.date("%d %m %Y"),
    trains = tonumber(GetVariable("today_trains")) or 0,
    pups   = tonumber(GetVariable("today_pups"))   or 0,
    gold   = tonumber(GetVariable("today_gold"))   or 0
  }

  local rep_chan = GetVariable("repchan") or "printcomm"
  local VTDebug = tonumber(GetVariable("VTDebug")) or 0

-------------------------------------------------------------------------------

function vt_help()
    Note (GetPluginInfo (GetPluginID (), 3))
end

function SetDebug(name, line, wildcards)
  local dmsg = "off"
  if (VTDebug == 0) then
    VTDebug = 1
    dmsg = "on"
  else
    VTDebug = 0
    dmsg = "off"
  end
  SetVariable("VTDebug", VTDebug)
  ColourNote ("darkorange", "", "VT Debug: " .. dmsg)
end

function DebugNote(text)
  if (VTDebug == 1) then
    ColourNote("darkorange", "", "VT Debug: ", "white", "", "" .. text)
  end
end

function tracker_settings(name, line, wildcards)
  rep_chan = wildcards[1]
    SetVariable("repchan", rep_chan)
      Note("")
      ColourNote("red", "", "   >>> ", "white", "", "VT Pups will report to: ", "red", "", rep_chan)
      Note("")
  SaveState()
end

function ResetPup()
  DebugNote("Pup Reset Triggered")
  local oldTime = newPup.finishTime

  newPup = {
    trains     = 0,
    bonus      = 0,
    startTime  = GetInfo(304),
    finishTime = oldTime,
    pupTime    = 0,
    kills      = 0,
    exp        = 0,
    gold       = 0
  }
end

function CmdTest(name, line, w)
  local pup = {
    trains     = 4,
    bonus      = 3,
    startTime  = GetInfo(304),
    finishTime = GetInfo(304) + 83,
    pupTime    = 83,
    kills      = 6,
    exp        = 1038,
    gold       = 7863
  }
  AddHistory(pup)
  EchoPup(pup)
  tprint(newPup)
end


function TrgPup(name, line, w)
  newPup.finishTime = GetInfo(304)
  EnableTriggerGroup("trgLevelInfo", true)
  EnableTrigger("trgFinish", true)
end


function TrgPupGains(name, line, w)
  if name == "pupgains" then
    newPup.trains = tonumber(w[1])
  elseif name == "bonusgains" then
    newPup.bonus = tonumber(w[1])
  elseif name == "blessingtrains" then
    newPup.bonus = newPup.bonus + tonumber(w[1])
  end
end


function TrgExp(name, line, w)
  local exp = 0

  if name == "trgMobExp" then
    exp = tonumber(w[1])

    newPup.kills = newPup.kills + 1

    if w[2] ~= "" and w[2] ~= nil then
      print(w[2])
      exp = exp + tonumber(w[2])
    end
    if w[3] ~= "" and w[3] ~= nil then
      print(w[3])
      exp = exp + tonumber(w[3])
    end
  elseif name == "trgBlessingExp" or name == "trgBonusExp" or name == "trgRareExp" then
    exp = tonumber(w[1])
  end

  newPup.exp = newPup.exp + exp
end


function TrgGold(name, line, w)
  local gold = 0
  local GoldTax = 0

  if name == "trgMobGold" or name == "trgCrubleGold" then
    gold = string.gsub(w[1], ",", "")
    gold = tonumber(gold)
    --DebugNote("Got Gold: " .. gold)
  elseif name == "trgClanTax" then
    GoldTax = string.gsub(w[1], ",", "")
    GoldTax = tonumber(GoldTax)
    gold      = gold - GoldTax
    DebugNote("I was taxed " .. GoldTax)
  elseif name == "trgSplitGoldOther" then
    gold = string.gsub(w[2], ",", "")
    gold = tonumber(gold)
    DebugNote("Other Shared with me: " .. gold)
  elseif name == "trgSplitGoldMine" then
    gold      = string.gsub(w[2], ",", "")
    gold      = tonumber(gold)
    minusGold = string.gsub(w[1], ",", "")
    minusGold = tonumber(minusGold)
    gold      = gold - minusGold
    DebugNote("I shared " .. gold .. " of " .. minusGold .. " meaning :" .. gold - minusGold)
  end

  newPup.gold = newPup.gold + gold
  DebugNote("I made: " ..newPup.gold)

  UpdateToday("gold", gold)
end


function TrgFinish(name, line, w)
  if newPup.trains > 0 then
    EnableTriggerGroup("trgLevelInfo", false)
    EnableTrigger("trgFinish", false)

    newPup.pupTime = newPup.finishTime - newPup.startTime

    UpdateToday("pups", 1)
    UpdateToday("trains", newPup.trains, newPup.bonus)

    EchoPup(newPup)

    ResetPup()
    CallPlugin ("b66c7a8e15787768e3f76d51", "Resetlevel")
  end
end


function EchoPup(pup)

  local echo = {}

  -- Pup Count
  table.insert(echo, string.format(
    "@DPups@w: @w%d",
    today.pups
  ))

  -- Time
  table.insert(echo, string.format(
    "@DTime@w: %s",
    util.formatTime(pup.pupTime)
  ))

  -- Mob deaths
  table.insert(echo, string.format(
    "@DKills@w: @w%d",
    pup.kills
  ))

  -- Trains
  table.insert(echo, string.format(
    "@DTrains@w: @w%d  @DToday@w: @w%d",
    pup.trains + pup.bonus,
    today.trains
  ))

  -- Gold
  table.insert(echo, string.format(
    "@DGold@w: @Y%s  @DToday@w: @Y%s",
    CommaValue(pup.gold),
    CommaValue(today.gold)
  ))

  local text = string.format("@R[@RVT@R %s@R]@w", strjoin("@R] [", echo))

  if rep_chan == "print" then
    util.print(text)
  elseif rep_chan == "printcomm" then
    tab = nil
    SendToCommLog(text)
  elseif rep_chan == "vtrack" then
    tab = "VTrack"
    SendToCommLog(text)
  else
    SendNoEcho(rep_chan .. " " .. text)
end


  --SendToCommLog(text)
end


function SendToCommLog(text)
  CallPlugin(
    "b555825a4a5700c35fa80780",
    "storeFromOutside",
    text,
    tab
  )
end


function UpdateToday(variable, ...)
  for k,v in ipairs({...}) do
    today[variable] = today[variable] + v
  end
end

function TmrCheckToday()

  local currDate = os.date("%d %m %Y")

  if today.date ~= currDate then
    today.date   = currDate
    today.pups   = 0
    today.trains = 0
    today.gold   = 0
    SetVariable("today_date",   currDate)
    SetVariable("today_pups",   today.pups)
    SetVariable("today_trains", today.trains)
    SetVariable("today_gold",   today.gold)
  end
end



function OnPluginSaveState()
  SetVariable("today_pups",   today.pups)
  SetVariable("today_trains", today.trains)
  SetVariable("today_gold",   today.gold)
end



-------------------------------------------------------------------------------
-- Utility Functions
-------------------------------------------------------------------------------

  util = {}
  defaultFromColor = "@x135"
  defaultTextColor = "@x208"

  function util.notify(func, text)
    Note("")
    ColourTell(
      "#00D7FF", "#FFFFFF", "[",
      "#222222", "#FFFFFF", "RP",
      "#00D7FF", "#FFFFFF", "]",
      "#000000", "", " "
    )

    local string = string.format(
      "%s@W: %s",
      defaultFromColor .. func:gsub('$C', defaultFromColor),
      defaultTextColor .. text:gsub("$C", defaultTextColor)
    )

    util.print(string)
  end

  function util.success(func, text)
    util.notify(func .. ' @W| @G[SUCCESS]', text)
  end

  function util.error(func, text)
    util.notify(func .. ' @W| @R[ERROR]', text)
  end

  function util.print(string)
    AnsiNote(stylesToANSI(ColoursToStyles(string)))
  end

  function util.secondsToDHMS(sSeconds)
    local nSeconds = tonumber(sSeconds)
    if nSeconds == 0 then
      return 0, 0, 0, 0, 0
    else
      local nYears = math.floor(nSeconds/(3600 * 24 * 365))
      nSeconds = nSeconds - (nYears * 365 * 24 * 60 * 60)
      local nDays = math.floor(nSeconds/(3600 * 24))
      local nHours = math.floor(nSeconds/3600 - (nDays * 24))
      local nMins = math.floor(nSeconds/60 - (nHours * 60) - (nDays * 24 * 60))
      local nSecs = sSeconds % 60
      return nYears, nDays, nHours, nMins, nSecs
    end
  end

  function util.formatTime(length)
    resetc = '@w'
    tcolour = '@W'
    ncolour = '@y'

    -- returns time in the format 10d:3h:4m:3s
    local tmsg = {}
    local years, days, hours, mins, secs = util.secondsToDHMS(length)
    if years > 0 then
      table.insert( tmsg, string.format( "%s%d%sy%s", tcolour, years or 0,
                                                        ncolour, resetc ) )
    end
    if days > 0 then
      table.insert( tmsg, string.format( "%s%02d%sd%s", tcolour, days or 0,
                                                        ncolour, resetc ) )
    end
    if hours > 0 then
      table.insert( tmsg, string.format( "%s%02d%sh%s", tcolour, hours or 0,
                                                        ncolour, resetc ) )
    end
    if mins > 0 or fmin then
      table.insert( tmsg, string.format( "%s%02d%sm%s", tcolour, mins or 0,
                                                        ncolour, resetc ) )
    end
    if secs > 0 or #tmsg == 0 then
      table.insert( tmsg, string.format( "%s%02d%ss%s", tcolour, secs or 0,
                                                        ncolour, resetc ) )
    end
    return strjoin(":", tmsg)
  end

  function strjoin(delimiter, list)
    local len = #list
    if len == 0 then
      return ""
    end
    local string = list[1]
    for i = 2, len do
      string = string .. delimiter .. list[i]
    end
    return string
  end

  function CommaValue(amount)
    local formatted = amount
    while true do
      formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", '%1,%2')
      if (k==0) then
        break
      end
    end
    return formatted
  end

function loaded()
    ColourNote("red", "", "   >>>", "white", "", " VTrackPups is loaded!  Use ", "red", "", "vtpups help", "white", "", " for VTrackPup Commands.")
end

DoAfterSpecial(2, "loaded()", 12)

]]>
</script>

</muclient>
