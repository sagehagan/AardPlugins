<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
  <plugin 
    name="Auto_Caster_GMCP" 
    author="Heracles" 
    id="54375a7029e6eebe04960408" 
    language="Lua" 
    purpose="GMCP Auto Caster - V46" 
    save_state="y" 
    version="46.0">
  </plugin>

  <triggers>
    <trigger enabled="y" match="^.*unaffected by your .*$" regexp="y" script="ImmunityTrigger" sequence="100" />
  </triggers>

  <aliases>
    <alias match="^acalt +(?&lt;args&gt;.+)$" enabled="y" regexp="y" script="AliasHandler" sequence="10" />
    <alias match="^acopen(?: +(?&lt;cmd&gt;.+))?$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acheal(?: +(?&lt;cmd&gt;.+))?$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acconsume$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acquaff(?: +(?&lt;type&gt;hp|mn|mv) +(?&lt;pct&gt;\d+) +(?&lt;cnt&gt;\d+))?$" enabled="y" regexp="y" script="QuaffHandler" sequence="20" />
    <alias match="^acquaff$" enabled="y" regexp="y" script="QuaffHandler" sequence="20" />
    <alias match="^ac debug$" enabled="y" regexp="y" script="ToggleDebug" sequence="20" />
    <alias match="^ac(?: +(?&lt;cmd&gt;.+))?$" enabled="y" regexp="y" script="AliasHandler" sequence="100" />
    <alias match="caster status" enabled="y" ignore_case="y" script="ShowStatus" />
    <alias match="caster help" enabled="y" ignore_case="y" script="ShowHelp" />
  </aliases>

  <script>
    <![CDATA[
    local last_cast_time = 0
    local is_navigator = false
    local GMCP_ID = "3e7dedbe37e44942dd46d264"
    local debug_mode = (GetVariable("debug_mode") or "0") == "1"

    local Caster = {
        enabled      = (GetVariable("enabled") or "1") == "1",
        is_fighting  = false,
        last_quaff   = 0,
        pause_cast   = false,
        using_alt    = false, 
        temp_disable = false, 
        
        cfg = {
            primary      = GetVariable("primary") or "",
            alt          = GetVariable("alt") or "", 
            pri_key      = GetVariable("pri_key") or "",
            alt_key      = GetVariable("alt_key") or "",
            opener       = GetVariable("opener") or "",
            opener_on    = (GetVariable("opener_on") or "0") == "1",
            heal         = GetVariable("heal") or "",
            heal_on      = (GetVariable("heal_on") or "0") == "1",
            consume      = (GetVariable("consume") or "0") == "1",
            quaff_on     = (GetVariable("quaff_on") or "0") == "1",
        },

        vitals = {
            hp = { pct = tonumber(GetVariable("hp_pct")) or 50, cnt = tonumber(GetVariable("hp_cnt")) or 2, item = "big heal", key = "hp", max_key = "maxhp" },
            mn = { pct = tonumber(GetVariable("mn_pct")) or 20, cnt = tonumber(GetVariable("mn_cnt")) or 2, item = "big mana", key = "mana", max_key = "maxmana" },
            mv = { pct = tonumber(GetVariable("mv_pct")) or 20, cnt = tonumber(GetVariable("mv_cnt")) or 2, item = "big move", key = "moves", max_key = "maxmoves" }
        }
    }

    function parse_gmcp(path)
        local res, val = CallPlugin(GMCP_ID, "gmcpval", path)
        if res == 0 and val and val ~= "" then
            local f, err = loadstring("return " .. val)
            if f then return f() end
        end
        return nil
    end

    function Caster.log(msg, color)
        ColourNote("red", "", " >>> ", color or "white", "", msg)
    end

    function Caster.warn(msg)
        ColourNote("white", "red", " !! CASTER WARNING !! ", "yellow", "black", " " .. msg .. " ")
    end

    function ToggleDebug()
        debug_mode = not debug_mode
        SetVariable("debug_mode", debug_mode and "1" or "0")
        Caster.log("Debug Messaging: " .. (debug_mode and "ON" or "OFF"), "cyan")
    end

    function ImmunityTrigger(name, line, wildcards)
        if not Caster.is_fighting or Caster.temp_disable then return end
        if Caster.cfg.pri_key == "none" then return end

        local text = line:lower()

        if not Caster.using_alt and Caster.cfg.pri_key ~= "" then
            if text:find(Caster.cfg.pri_key:lower()) then
                if Caster.cfg.alt ~= "" then
                    Caster.warn("PRIMARY [" .. Caster.cfg.pri_key .. "] IMMUNE! Swapping to Alt Skill.")
                    Caster.using_alt = true
                    last_cast_time = 0 
                else
                    Caster.warn("PRIMARY [" .. Caster.cfg.pri_key .. "] IMMUNE! Shutdown.")
                    Caster.temp_disable = true
                end
                return
            end
        end

        if Caster.using_alt and Caster.cfg.alt_key ~= "" then
            if text:find(Caster.cfg.alt_key:lower()) then
                Caster.warn("ALT [" .. Caster.cfg.alt_key .. "] IMMUNE! Full Shutdown.")
                Caster.temp_disable = true
            end
        end
    end

    function Caster.heartbeat()
        if not Caster.enabled or not Caster.is_fighting or Caster.pause_cast or Caster.temp_disable then return end
        local cooldown = is_navigator and 0.25 or 2.1
        local now = os.clock()

        if (now - last_cast_time) >= cooldown then
            local skill = Caster.using_alt and Caster.cfg.alt or Caster.cfg.primary
            if skill ~= "" then
                Execute(skill)
                last_cast_time = now 
            end
        end
    end

    function Caster.check_vitals()
        local now = os.clock()
        if Caster.pause_cast and (now - Caster.last_quaff) > 3 then Caster.pause_cast = false end
        if not Caster.cfg.quaff_on or not Caster.enabled or not Caster.is_fighting then return end
        if (now - Caster.last_quaff) < 3 then return end

        local current_vitals = parse_gmcp("char.vitals")
        local max_vitals = parse_gmcp("char.maxstats")
        if not current_vitals or not max_vitals then return end

        for _, k in ipairs({"hp", "mn", "mv"}) do
            local d = Caster.vitals[k]
            local cur, max = tonumber(current_vitals[d.key]), tonumber(max_vitals[d.max_key])
            if cur and max and (cur/max*100) < d.pct then
                Caster.log("Low " .. k:upper() .. "! Quaffing " .. d.cnt .. "x " .. d.item, "yellow")
                Caster.pause_cast = true
                for i = 1, d.cnt do Execute("dinv consume " .. d.item) end
                Caster.last_quaff = now
                return 
            end
        end
    end

    function QuaffHandler(name, line, wildcards)
        if line == "acquaff" then
            Caster.cfg.quaff_on = not Caster.cfg.quaff_on
            SetVariable("quaff_on", Caster.cfg.quaff_on and "1" or "0")
            Caster.log("Auto-Quaff: " .. (Caster.cfg.quaff_on and "ON" or "OFF"), Caster.cfg.quaff_on and "lime" or "red")
        else
            local t, pct, cnt = wildcards.type:lower(), tonumber(wildcards.pct), tonumber(wildcards.cnt)
            if Caster.vitals[t] then
                Caster.vitals[t].pct, Caster.vitals[t].cnt = pct, cnt
                SetVariable(t .. "_pct", tostring(pct)); SetVariable(t .. "_cnt", tostring(cnt))
                Caster.log(t:upper() .. " quaff set to " .. pct .. "% (Repeat " .. cnt .. "x)", "cyan")
            end
        end
        SaveState()
    end

    function AliasHandler(name, line, wildcards)
        local cmd = line:lower()

        if cmd:find("^acalt") then
            local args = {}
            for word in wildcards.args:gmatch("%S+") do table.insert(args, word) end
            
            if args[1] == "none" then
                Caster.cfg.pri_key = "none"; Caster.cfg.alt_key = ""; Caster.cfg.alt = ""
                Caster.log("Immunity Tracking: DISABLED", "lime")
            elseif #args == 1 then
                Caster.cfg.pri_key = args[1]; Caster.cfg.alt_key = ""; Caster.cfg.alt = ""
                Caster.log("Immunity Tracking: SHUTDOWN on [" .. args[1] .. "].", "orange")
            elseif #args >= 3 then
                Caster.cfg.pri_key = args[1]; Caster.cfg.alt_key = args[2]
                local skill_parts = {}
                for i = 3, #args do table.insert(skill_parts, args[i]) end
                Caster.cfg.alt = table.concat(skill_parts, " ")
                Caster.log("Immunity Tracking: [" .. args[1] .. "] -> Swap to [" .. Caster.cfg.alt .. "] -> Shutdown on [" .. args[2] .. "].", "cyan")
            end
            SetVariable("pri_key", Caster.cfg.pri_key); SetVariable("alt_key", Caster.cfg.alt_key); SetVariable("alt", Caster.cfg.alt)
        elseif cmd:find("^acopen") then
            local val = wildcards.cmd or ""
            if val == "" then Caster.cfg.opener_on = not Caster.cfg.opener_on
            else Caster.cfg.opener = val; Caster.cfg.opener_on = true; SetVariable("opener", val) end
            SetVariable("opener_on", Caster.cfg.opener_on and "1" or "0")
            Caster.log("Opener: " .. (Caster.cfg.opener_on and "ON" or "OFF"), Caster.cfg.opener_on and "lime" or "red")
        elseif cmd:find("^acheal") then
            local val = wildcards.cmd or ""
            if val == "" then Caster.cfg.heal_on = not Caster.cfg.heal_on
            else Caster.cfg.heal = val; Caster.cfg.heal_on = true; SetVariable("heal", val) end
            SetVariable("heal_on", Caster.cfg.heal_on and "1" or "0")
            Caster.log("Recovery: " .. (Caster.cfg.heal_on and "ON" or "OFF"), Caster.cfg.heal_on and "lime" or "red")
        elseif cmd:find("^acconsume") then
            Caster.cfg.consume = not Caster.cfg.consume; SetVariable("consume", Caster.cfg.consume and "1" or "0")
            Caster.log("Post-combat 'consume': " .. (Caster.cfg.consume and "ON" or "OFF"))
        else
            local val = wildcards.cmd or ""
            if val == "" then
                Caster.enabled = not Caster.enabled; SetVariable("enabled", Caster.enabled and "1" or "0")
                Caster.log("Caster System: " .. (Caster.enabled and "ON" or "OFF"), Caster.enabled and "lime" or "red")
            else
                Caster.cfg.primary = val; SetVariable("primary", val)
                Caster.log("Primary set to: " .. val, "cyan")
            end
        end
        SaveState()
    end

    function ShowStatus(name, line, wildcards)
        local function onoff(b) return b and "ON" or "OFF", b and "lime" or "red" end
        ColourNote("silver", "", "--------------------------------------------------")
        ColourNote("cyan", "", " [ CASTER SYSTEM STATUS ] ")
        Note("")
        local s, sc = onoff(Caster.enabled)
        ColourTell("silver", "", " System Power:      ") ColourNote(sc, "", s)
        ColourTell("silver", "", " Primary Skill:     ") ColourNote("yellow", "", Caster.cfg.primary)
        ColourTell("silver", "", " Alt Skill:         ") ColourNote("orange", "", Caster.cfg.alt ~= "" and Caster.cfg.alt or "None")
        ColourTell("silver", "", " Immunity Triggers: ") ColourNote("gray", "", "[" .. Caster.cfg.pri_key .. "] -> [" .. Caster.cfg.alt_key .. "]")
        Note("")
        local op, opc = onoff(Caster.cfg.opener_on); local he, hec = onoff(Caster.cfg.heal_on)
        ColourTell("silver", "", " Opener (Start):    ") ColourTell(opc, "", op) ColourNote("gray", "", " [" .. Caster.cfg.opener .. "]")
        ColourTell("silver", "", " Heal (End):        ") ColourTell(hec, "", he) ColourNote("gray", "", " [" .. Caster.cfg.heal .. "]")
        Note("")
        local qu, quc = onoff(Caster.cfg.quaff_on)
        ColourTell("silver", "", " Auto-Quaff:        ") ColourNote(quc, "", qu)
        ColourNote("silver", "", "--------------------------------------------------")
    end

    function ShowHelp(name, line, wildcards)
        ColourNote("silver", "", "--------------------------------------------------")
        ColourNote("cyan", "", " [ AUTO-CASTER GMCP HELP ] ")
        Note("")
        ColourTell("yellow", "", " ac <skill>           ") ColourNote("silver", "", "   - Set primary attack loop.")
        ColourTell("orange", "", " acalt none           ") ColourNote("silver", "", "   - Disable all immunity shutdowns.")
        ColourTell("orange", "", " acalt <trig1>        ") ColourNote("silver", "", "   - Shutdown if trig1 is unaffected.")
        ColourTell("orange", "", " acalt <t1> <t2> <sk> ") ColourNote("silver", "", "   - Fallback to <sk> on t1, shutdown on t2.")
        ColourTell("yellow", "", " ac                   ") ColourNote("silver", "", "   - Toggle main system power.")
        Note("")
        ColourTell("lime", "", " acopen <skill>       ") ColourNote("silver", "", "   - Fires ONCE at start of combat.")
        ColourNote("gray", "", "   Example: acopen cast 8 (Casts spell 8 on combat start)")
        Note("")
        ColourTell("lime", "", " acheal <skill>       ") ColourNote("silver", "", "   - Fires ONCE at end of combat.")
        ColourNote("gray", "", "   Example: acheal c 106 heracles (exclude target to heal self)")
        Note("")
        ColourTell("lime", "", " acconsume            ") ColourNote("silver", "", "   - Toggle 'consume' command after combat.")
        Note("")
        ColourTell("orange", "", " acquaff <t> <%> <c>  ") Note("")
        ColourTell("silver", "", "   Type <t>: hp | mn | mv")
        ColourNote("gray", "", "   Example: acquaff hp 40 3 (Quaff 3x at 40% HP)")
        Note("")
        ColourTell("orange", "", " acquaff              ") ColourNote("silver", "", "   - Toggle auto-potions.")
        Note("")
        ColourNote("red", "", " WARNING: Auto-Quaff REQUIRES Durel's 'dinv' plugin.")
        ColourNote("red", "", " Ensure 'dinv consume big mana' (etc) is configured.")
        Note("")
        ColourNote("cyan", "", " IMMUNITY FALLBACK LOGIC:")
        Note(" 1. System monitors lines containing 'unaffected by your'.")
        Note(" 2. If acalt is 'none', system never stops for immunity.")
        Note(" 3. If trig2/alt skill are provided, it swaps skills once.")
        Note("")
        ColourNote("gray", "", " Example: acalt fury neural cast 360")
        Note(" -> If Your 'fury' is unaffected: Swaps to 'cast 360'.")
        Note(" -> If Your 'neural' is unaffected: Shutdown.")
        Note("")
        ColourNote("red", "", " Fallback chains from Primary -> Alt -> Lockdown.")
        ColourNote("silver", "", "--------------------------------------------------")
    end

    function OnPluginBroadcast(msg, id, name, text)
        if id ~= GMCP_ID then return end
        if text == "char.vitals" then
            Caster.check_vitals()
            Caster.heartbeat()
        elseif text == "char.status" then
            local status = parse_gmcp("char.status")
            if not status then return end
            local fighting = (status.state == "8")
            
            if fighting and not Caster.is_fighting and Caster.enabled then
                if Caster.cfg.opener_on and Caster.cfg.opener ~= "" then
                    Execute(Caster.cfg.opener)
                    last_cast_time = os.clock()
                elseif Caster.cfg.primary ~= "" then
                    Execute(Caster.cfg.primary)
                    last_cast_time = os.clock()
                end
            elseif not fighting and Caster.is_fighting then
                if Caster.cfg.heal_on and Caster.cfg.heal ~= "" then Execute(Caster.cfg.heal) end
                if Caster.cfg.consume then Execute("consume") end
                Caster.using_alt = false; Caster.temp_disable = false; Caster.pause_cast = false
            end
            
            Caster.is_fighting = fighting
            local base = parse_gmcp("char.base")
            if base then is_navigator = (base.subclass == "Navigator") end
        end
    end
    Caster.log("Auto Caster V46.0 Loaded. Use Caster Help and Caster Status", "lime")
    ]]>
  </script>
</muclient>