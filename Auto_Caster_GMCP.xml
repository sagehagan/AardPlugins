<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
  <plugin 
    name="Auto_Caster_GMCP" 
    author="Heracles" 
    id="54375a7029e6eebe04960408" 
    language="Lua" 
    purpose="Automatic Spell/Skill Casting" 
    save_state="y" 
    version="9.4">
  </plugin>

  <triggers>
    <trigger 
      enabled="y" 
      match="^.*Your (?<keyword>\S+) .+$" 
      regexp="y" 
      script="RecastHandler" 
      sequence="100" 
    />
    <trigger 
      enabled="y" 
      match="^.* is unaffected by your (?<keyword>[^ .!]+).*$" 
      regexp="y" 
      script="ImmunityTrigger" 
      sequence="90" 
    />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* is DEAD!!?$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* is damned forever by the holy power!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* screams in agony as the acid consumes (?:him|her|it)!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* crumbles as (?:he|she|it) is battered to death!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* goes stiff as (?:he|she|it) is frozen to death!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* smoulders as the lightning destroys (?:him|her|it)!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* falls dead as (?:his|her|its) mind is destroyed!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* is slain by a final deadly stab!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* is slain by a final deadly slash!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* is destroyed by the blast!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* howls as (?:his|her|its) last spark of life is drained!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* disease removes (?:him|she|it) from this world!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* screams as the flames engulf (?:him|her|it)!!$" />
    <trigger enabled="y" regexp="y" sequence="80" script="DeathHandler" match="^.* is battered to death by the force of the water!$" />
  </triggers>

  <aliases>
    <alias match="^ac +(?<trig>\S+) +(?<skill>.+)$" enabled="y" regexp="y" script="AliasHandler" sequence="10" />
    <alias match="^ac +none$" enabled="y" regexp="y" script="AliasHandler" sequence="9" />
    <alias match="^acalt +(?<trig>\S+) +(?<skill>.+)$" enabled="y" regexp="y" script="AliasHandler" sequence="10" />
    <alias match="^acalt +none$" enabled="y" regexp="y" script="AliasHandler" sequence="9" />
    <alias match="^acopen(?: +(?<cmd>.+))?$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acheal(?: +(?<cmd>.+))?$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acconsume$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acstab$" enabled="y" regexp="y" script="AliasHandler" sequence="20" />
    <alias match="^acquaff(?: +(?<type>hp|mn|mv) +(?<pct>\d+) +(?<cnt>\d+))?$" enabled="y" regexp="y" script="QuaffHandler" sequence="20" />
    <alias match="^acquaff$" enabled="y" regexp="y" script="QuaffHandler" sequence="20" />
    <alias match="caster debug" enabled="y" ignore_case="y" script="ToggleDebug" />
    <alias match="^ac$" enabled="y" regexp="y" script="AliasHandler" sequence="100" />
    <alias match="caster status" enabled="y" ignore_case="y" script="ShowStatus" />
    <alias match="caster help" enabled="y" ignore_case="y" script="ShowHelp" />
  </aliases>

  <script>
    <![CDATA[
    local GMCP_ID = "3e7dedbe37e44942dd46d264"
    local INV_ID = "88c86ea252fc1918556df9fe"
    local debug_mode = (GetVariable("debug_mode") or "0") == "1"
    
    local Caster = {
        enabled      = (GetVariable("enabled") or "1") == "1",
        is_fighting  = false,
        last_quaff   = 0,
        last_recast_time = 0, 
        blocked_casts = 0,
        pause_cast   = false,
        using_alt    = false, 
        temp_disable = false, 
        quaff_override = false,
        subclass     = "Unknown",
        recast_speed = 2.0,
        can_backstab = true,
        backstab_pending = false, 
        
        cfg = {
            primary      = GetVariable("primary") or "",
            alt          = GetVariable("alt") or "", 
            pri_trig     = GetVariable("pri_trig") or "",
            alt_trig     = GetVariable("alt_trig") or "",
            opener       = GetVariable("opener") or "",
            opener_on    = (GetVariable("opener_on") or "0") == "1",
            heal         = GetVariable("heal") or "",
            heal_on      = (GetVariable("heal_on") or "0") == "1",
            consume      = (GetVariable("consume") or "0") == "1",
            quaff_on     = (GetVariable("quaff_on") or "0") == "1",
            stab_on      = (GetVariable("stab_on") or "1") == "1",
        },

        vitals = {
            hp = { pct = tonumber(GetVariable("hp_pct")) or 50, cnt = tonumber(GetVariable("hp_cnt")) or 2, item = "big heal", key = "hp", max_key = "maxhp", inv_type = "heal" },
            mn = { pct = tonumber(GetVariable("mn_pct")) or 20, cnt = tonumber(GetVariable("mn_cnt")) or 2, item = "big mana", key = "mana", max_key = "maxmana", inv_type = "mana" },
            mv = { pct = tonumber(GetVariable("mv_pct")) or 20, cnt = tonumber(GetVariable("mv_cnt")) or 2, item = "big move", key = "moves", max_key = "maxmoves", inv_type = "move" }
        }
    }

    function parse_gmcp(path)
        local res, val = CallPlugin(GMCP_ID, "gmcpval", path)
        if res == 0 and val and val ~= "" then
            local f, err = loadstring("return " .. val)
            if f then return f() end
        end
        return nil
    end

    function Caster.update_subclass()
        local base = parse_gmcp("char.base")
        if base and base.subclass then
            Caster.subclass = base.subclass
            Caster.recast_speed = (Caster.subclass:lower() == "navigator") and 0.5 or 2.0
        end
    end

    function Caster.log(msg, default_color)
        local colors = { 
            ["@R"] = "red", ["@Y"] = "yellow", ["@D"] = "silver", 
            ["@C"] = "cyan", ["@G"] = "lime", ["@M"] = "magenta"
        }
        ColourTell("red", "", " >>> ")
        local current_color = default_color or "white"
        local last_pos = 1
        for code, pos in msg:gmatch("(@%u)()") do
            local text_segment = msg:sub(last_pos, pos - 3)
            if text_segment ~= "" then ColourTell(current_color, "", text_segment) end
            current_color = colors[code] or current_color
            last_pos = pos
        end
        local final_segment = msg:sub(last_pos)
        if final_segment ~= "" then ColourTell(current_color, "", final_segment) end
        Note("") 
    end

    function Caster.warn(msg)
        ColourNote("white", "red", " !! CASTER WARNING !! ", "yellow", "black", " " .. msg .. " ")
    end

    function ToggleDebug()
        debug_mode = not debug_mode
        SetVariable("debug_mode", debug_mode and "1" or "0")
        Caster.log("Debug Messaging: " .. (debug_mode and "ON" or "OFF"), "cyan")
    end

    function DeathHandler(name, line, wildcards)
        if Caster.subclass:lower() == "ninja" and Caster.cfg.stab_on and Caster.is_fighting then
            if not Caster.backstab_pending then
                Caster.backstab_pending = true
                Caster.can_backstab = true
                Execute("backstab")
                if debug_mode then Caster.log("Mob Dead: Queuing Backstab.", "lime") end
            else
                if debug_mode then Caster.log("Mob Dead: Backstab already pending, skipping.", "orange") end
            end
        end
    end

    function Caster.do_cast()
        if not Caster.enabled or not Caster.is_fighting or Caster.temp_disable then return end
        
        if Caster.pause_cast and not Caster.quaff_override then
            Caster.blocked_casts = Caster.blocked_casts + 1
            if Caster.blocked_casts >= 3 then
                Caster.warn("Safety Trigger: 3 Recasts Blocked. Resuming Fire.")
                Caster.quaff_override = true
            else return end
        end

        local skill = Caster.using_alt and Caster.cfg.alt or Caster.cfg.primary
        
        if Caster.subclass:lower() == "ninja" and Caster.cfg.stab_on and Caster.can_backstab then
            Caster.can_backstab = false
            Caster.backstab_pending = true
            Execute(skill ~= "" and ("backstab;" .. skill) or "backstab")
        elseif skill ~= "" then
            Execute(skill)
        end
    end

    function RecastHandler(name, line, wildcards)
        if not Caster.is_fighting or not Caster.enabled then return end
        local word = wildcards.keyword:lower()

        if word == "backstab" then
            Caster.backstab_pending = false
            if debug_mode then Caster.log("Backstab successful: lock reset.", "lime") end
        end

        local active_trig = (Caster.using_alt and Caster.cfg.alt_trig or Caster.cfg.pri_trig):lower()
        
        if word == active_trig then
            local now = os.clock()
            if (now - Caster.last_recast_time) < Caster.recast_speed then
                if debug_mode then Caster.log(string.format("Recast Halted: %.1fs Cooldown.", Caster.recast_speed), "orange") end
                return
            end
            Caster.last_recast_time = now
            Caster.do_cast()
        end
    end

    function ImmunityTrigger(name, line, wildcards)
        if not Caster.is_fighting or Caster.temp_disable then return end
        local resisted_skill = wildcards.keyword:lower()
        if not Caster.using_alt and resisted_skill == Caster.cfg.pri_trig:lower() then
            if Caster.cfg.alt ~= "" then
                Caster.warn("PRIMARY IMMUNE (" .. resisted_skill .. ")! Swapping to Alt.")
                Caster.using_alt = true
                Caster.last_recast_time = 0 
                Caster.do_cast()
            else
                Caster.warn("PRIMARY IMMUNE (" .. resisted_skill .. ")! No Alt set. Shutting down.")
                Caster.temp_disable = true
            end
        elseif Caster.using_alt and resisted_skill == Caster.cfg.alt_trig:lower() then
            Caster.warn("ALTERNATE IMMUNE (" .. resisted_skill .. ")! Emergency Shutdown.")
            Caster.temp_disable = true
        end
    end

    function Caster.check_vitals()
        local now = os.clock()
        if Caster.pause_cast and (now - Caster.last_quaff) > 3 then 
            Caster.pause_cast = false 
            Caster.do_cast()
        end
        if not Caster.cfg.quaff_on or not Caster.enabled or not Caster.is_fighting then return end
        if (now - Caster.last_quaff) < 3 then return end
        local current_vitals = parse_gmcp("char.vitals")
        local max_vitals = parse_gmcp("char.maxstats")
        if not current_vitals or not max_vitals then return end

        for _, k in ipairs({"hp", "mn", "mv"}) do
            local d = Caster.vitals[k]
            local cur, max = tonumber(current_vitals[d.key]), tonumber(max_vitals[d.max_key] or max_vitals["max"..d.key])
            if cur and max and (cur/max*100) < d.pct then
                local res, count = CallPlugin(INV_ID, "GetConsumeCount", d.inv_type)
                local num_count = tonumber(count) or 0
                
                if debug_mode then
                    Caster.log(string.format("Inv Check [%s]: Count=%d", d.inv_type, num_count), "cyan")
                end

                if num_count > 0 then
                    Caster.log("Low " .. k:upper() .. "! Delaying recast 3s.", "yellow")
                    Caster.pause_cast = true
                    for i = 1, d.cnt do Execute("dinv consume " .. d.item) end
                    Caster.last_quaff = now
                    return 
                else
                    Caster.warn("Low " .. k:upper() .. "! No potions available!")
                    return
                end
            end
        end
    end

    function QuaffHandler(name, line, wildcards)
        if line == "acquaff" then
            Caster.cfg.quaff_on = not Caster.cfg.quaff_on
            SetVariable("quaff_on", Caster.cfg.quaff_on and "1" or "0")
            Caster.log("Auto-Quaff: " .. (Caster.cfg.quaff_on and "ON" or "OFF"), Caster.cfg.quaff_on and "lime" or "red")
        else
            local t, pct, cnt = wildcards.type:lower(), tonumber(wildcards.pct), tonumber(wildcards.cnt)
            if Caster.vitals[t] then
                Caster.vitals[t].pct, Caster.vitals[t].cnt = pct, cnt
                SetVariable(t .. "_pct", tostring(pct)); SetVariable(t .. "_cnt", tostring(cnt))
                Caster.log(t:upper() .. " monitoring set to " .. pct .. "% (" .. cnt .. "x)", "cyan")
            end
        end
        SaveState()
    end

    function AliasHandler(name, line, wildcards)
        local cmd = line:lower()
        if cmd:find("^acalt none") then
            Caster.cfg.alt = ""; Caster.cfg.alt_trig = ""
            SetVariable("alt", ""); SetVariable("alt_trig", "")
            Caster.log("Alternate settings cleared.", "lime")
        elseif cmd:find("^acalt") then
            Caster.cfg.alt_trig = wildcards.trig; Caster.cfg.alt = wildcards.skill
            SetVariable("alt_trig", wildcards.trig); SetVariable("alt", wildcards.skill)
            Caster.log("ALT SET: Trigger [" .. wildcards.trig .. "] -> Skill [" .. wildcards.skill .. "]", "orange")
        elseif cmd:find("^ac +none") then
            Caster.cfg.pri_trig = ""; Caster.cfg.primary = ""
            SetVariable("pri_trig", ""); SetVariable("primary", "")
            Caster.log("Primary settings cleared.", "lime")
        elseif cmd:find("^ac +") then
            Caster.cfg.pri_trig = wildcards.trig; Caster.cfg.primary = wildcards.skill
            SetVariable("pri_trig", wildcards.trig); SetVariable("primary", wildcards.skill)
            Caster.log("PRIMARY SET: Trigger [" .. wildcards.trig .. "] -> Skill [" .. wildcards.skill .. "]", "cyan")
        elseif cmd == "ac" then
            Caster.enabled = not Caster.enabled; SetVariable("enabled", Caster.enabled and "1" or "0")
            Caster.log("Caster Power: " .. (Caster.enabled and "ON" or "OFF"), Caster.enabled and "lime" or "red")
        elseif cmd:find("^acopen") then
            local val = wildcards.cmd or ""
            if val == "" then Caster.cfg.opener_on = not Caster.cfg.opener_on
            else Caster.cfg.opener = val; Caster.cfg.opener_on = true; SetVariable("opener", val) end
            SetVariable("opener_on", Caster.cfg.opener_on and "1" or "0")
            Caster.log("Opener " .. (Caster.cfg.opener_on and "Enabled" or "Disabled"))
        elseif cmd:find("^acheal") then
            local val = wildcards.cmd or ""
            if val == "" then Caster.cfg.heal_on = not Caster.cfg.heal_on
            else Caster.cfg.heal = val; Caster.cfg.heal_on = true; SetVariable("heal", val) end
            SetVariable("heal_on", Caster.cfg.heal_on and "1" or "0")
            Caster.log("Recovery " .. (Caster.cfg.heal_on and "Enabled" or "Disabled"))
        elseif cmd:find("^acconsume") then
            Caster.cfg.consume = not Caster.cfg.consume; SetVariable("consume", Caster.cfg.consume and "1" or "0")
            Caster.log("Combat Consume: " .. (Caster.cfg.consume and "ON" or "OFF"))
        elseif cmd:find("^acstab") then
            Caster.cfg.stab_on = not Caster.cfg.stab_on; SetVariable("stab_on", Caster.cfg.stab_on and "1" or "0")
            Caster.log("Ninja Backstab: " .. (Caster.cfg.stab_on and "ON" or "OFF"), Caster.cfg.stab_on and "lime" or "red")
        end
        SaveState()
    end

    function ShowStatus(name, line, wildcards)
        Caster.update_subclass()
        local function status_tag(b) return b and "[ ACTIVE ]" or "[ INACTIVE ]", b and "lime" or "red" end
        local function val_tag(v) return v ~= "" and v or "Not Set", v ~= "" and "yellow" or "gray" end
        ColourNote("silver", "", "======================================================================")
        ColourTell("cyan", "", " [ CASTER SYSTEM v9.4 ]") 
        local p, pc = status_tag(Caster.enabled)
        ColourTell("silver", "", " Status: ") ColourNote(pc, "", p)
        
        ColourTell("silver", "", "    Class Info:     ") 
        ColourTell("magenta", "", string.format("%-14s", Caster.subclass))
        ColourNote("silver", "", "Recast Speed: " .. Caster.recast_speed .. "s")
        
        ColourTell("silver", "", "    Backstab Mode:  ")
        if Caster.subclass:lower() == "ninja" then
            local onoff, oncol = Caster.cfg.stab_on and "[ ENABLED ]" or "[ DISABLED ]", Caster.cfg.stab_on and "lime" or "red"
            ColourTell(oncol, "", onoff .. " ")
            ColourTell("silver", "", "- Can Backstab ")
            local bst, bsc = (Caster.can_backstab and "[ TRUE ]" or "[ FALSE ]"), (Caster.can_backstab and "lime" or "red")
            ColourNote(bsc, "", bst)
        else
            ColourNote("gray", "", "[ Not Ninja ] - Backstab Disabled")
        end
        Note("")

        ColourNote("silver", "", " COMMANDS & TRIGGERS")
        local p_val, p_col = val_tag(Caster.cfg.primary)
        ColourTell("silver", "", "    Primary Loop:   ") ColourTell("cyan", "", string.format("%-12s", "   [" .. Caster.cfg.pri_trig .. "]")) 
        ColourNote(p_col, "", " -> " .. p_val)
        local a_val, a_col = val_tag(Caster.cfg.alt)
        ColourTell("silver", "", "    Alternate Loop: ") ColourTell("orange", "", string.format("%-12s", "   [" .. Caster.cfg.alt_trig .. "]")) 
        ColourNote(a_col, "", " -> " .. a_val)
        Note("")
        ColourNote("silver", "", " COMBAT SEQUENCE")
        local op, opc = status_tag(Caster.cfg.opener_on)
        ColourTell("silver", "", "    Opener:           ") ColourTell(opc, "", string.format("%-14s", op)) ColourNote("gray", "", "Cmd: " .. (Caster.cfg.opener ~= "" and Caster.cfg.opener or "None"))
        local he, hec = status_tag(Caster.cfg.heal_on)
        ColourTell("silver", "", "    Recovery:         ") ColourTell(hec, "", string.format("%-14s", he)) ColourNote("gray", "", "Cmd: " .. (Caster.cfg.heal ~= "" and Caster.cfg.heal or "None"))
        local co, coc = status_tag(Caster.cfg.consume)
        ColourTell("silver", "", "    Consume:          ") ColourNote(coc, "", co)
        Note("")
        ColourNote("silver", "", " VITAL MONITORING (AUTO-QUAFF)")
        local qu, quc = status_tag(Caster.cfg.quaff_on)
        ColourTell("silver", "", "    Power:            ") ColourNote(quc, "", qu)
        ColourTell("silver", "", "    Thresholds:       ")
        ColourTell("lime", "", "HP: " .. Caster.vitals.hp.pct .. "% (" .. Caster.vitals.hp.cnt .. "x)   ")
        ColourTell("cyan", "", "MN: " .. Caster.vitals.mn.pct .. "% (" .. Caster.vitals.mn.cnt .. "x)   ")
        ColourNote("orange", "", "MV: " .. Caster.vitals.mv.pct .. "% (" .. Caster.vitals.mv.cnt .. "x)")
        ColourNote("silver", "", "======================================================================")
    end

    function ShowHelp(name, line, wildcards)
        ColourNote("silver", "", "----------------------------------------------------------------------")
        ColourNote("cyan", "", " [ AUTO-CASTER COMMAND REFERENCE ]")
        Note("")
        ColourTell("yellow", "", " ac <trig> <skill>    ") ColourNote("silver", "", "Set primary recast trigger and command.")
        ColourTell("yellow", "", " ac none              ") ColourNote("silver", "", "Clear the primary loop settings.")
        ColourTell("orange", "", " acalt <trig> <skill> ") ColourNote("silver", "", "Set fallback trigger/command for immunity.")
        ColourTell("orange", "", " acalt none           ") ColourNote("silver", "", "Clear the alternate fallback loop.")
        ColourTell("yellow", "", " ac                   ") ColourNote("silver", "", "Toggle main plugin power.")
        Note("")
        ColourTell("lime", "", " acopen <skill>       ") ColourNote("silver", "", "Toggle/Set skill fired at combat start.")
        ColourTell("lime", "", " acheal <skill>       ") ColourNote("silver", "", "Toggle/Set skill fired at combat end.")
        ColourTell("lime", "", " acconsume            ") ColourNote("silver", "", "Toggle post-combat 'consume' command.")
        ColourTell("lime", "", " acstab               ") ColourNote("silver", "", "Toggle Ninja backstab functionality.")
        Note("")
        ColourTell("cyan", "", " acquaff <t> <%> <c>  ") ColourNote("silver", "", "Set vital type (hp|mn|mv), %, and repeat.")
        ColourTell("cyan", "", " acquaff              ") ColourNote("silver", "", "Toggle the Auto-Quaff system.")
        Note("")
        ColourTell("white", "", " caster status        ") ColourNote("silver", "", "View current settings and vital levels.")
        ColourTell("white", "", " caster help          ") ColourNote("silver", "", "Display this help menu.")
        ColourTell("white", "", " caster debug         ") ColourNote("silver", "", "Toggle debug messaging.")
        Note("")
        ColourNote("silver", "", " EXAMPLES:")
        Note("    ac fury cast 626                 - Matches 'Your fury'")
        Note("    acquaff hp 40 3                  - Quaffs 3 heals when HP falls below 40%.")
        Note("")
        ColourNote("red", "", " Auto Quaff requires Durel's Inventory Plugin")
        Note("")
        ColourNote("silver", "", " LOGIC & SAFETY:")
        Note(" 1. START: Fires Opener then leads with Backstab + Primary Skill.")
        Note(" 2. RECAST: Fires ONLY when damage word (trig) is detected.")
        Note(" 3. NINJA: Backstabs once at start, then every time a mob dies while fighting.")
        Note(" 4. IMMUNITY: Swaps to Alt or shuts down if unaffected.")
        Note(" 5. QUAFF: Checks stock via Aard_Inventory; stops for 3s per quaff.")
        Note("")
        ColourNote("silver", "", "----------------------------------------------------------------------")
    end

    function OnPluginBroadcast(msg, id, name, text)
        if id ~= GMCP_ID then return end
        if text == "char.vitals" then
            Caster.check_vitals()
        elseif text == "char.base" then
            Caster.update_subclass()
        elseif text == "char.status" then
            local status = parse_gmcp("char.status")
            if not status then return end
            local fighting = (status.state == "8")
            if fighting and not Caster.is_fighting then
                Caster.is_fighting = true
                Caster.can_backstab = true
                Caster.backstab_pending = false 
                if Caster.enabled then
                    if Caster.cfg.opener_on and Caster.cfg.opener ~= "" then Execute(Caster.cfg.opener) end
                    Caster.do_cast()
                end
            elseif not fighting and Caster.is_fighting then
                Caster.is_fighting = false
                if Caster.cfg.heal_on and Caster.cfg.heal ~= "" then Execute(Caster.cfg.heal) end
                if Caster.cfg.consume then Execute("consume") end
                Caster.using_alt = false; Caster.temp_disable = false; Caster.pause_cast = false; Caster.last_recast_time = 0; Caster.backstab_pending = false
            end
        end
    end

    Caster.update_subclass()
    Caster.log("@YAuto Caster Ready @DUse @Ccaster help @Dand @Ccaster status @Dfor more info.", "lime")
    ]]>
  </script>
</muclient>