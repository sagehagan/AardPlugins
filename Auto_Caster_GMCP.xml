<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
  <plugin 
    name="Auto_Caster_GMCP" 
    author="Heracles" 
    id="54375a7029e6eebe04960408" 
    language="Lua" 
    purpose="GMCP Auto Caster - V22 Help File Bugfix" 
    save_state="y" 
    version="22.0">
  </plugin>

  <aliases>
    <alias match="^ac(?: +(?&lt;cmd&gt;.+))?$" enabled="y" regexp="y" script="AliasHandler" />
    <alias match="^acopen(?: +(?&lt;cmd&gt;.+))?$" enabled="y" regexp="y" script="AliasHandler" />
    <alias match="^acheal(?: +(?&lt;cmd&gt;.+))?$" enabled="y" regexp="y" script="AliasHandler" />
    <alias match="^acconsume$" enabled="y" regexp="y" script="AliasHandler" />
    <alias match="^ac debug$" enabled="y" regexp="y" script="ToggleDebug" />
    <alias match="^acquaff(?: +(?&lt;type&gt;hp|mn|mv) +(?&lt;pct&gt;\d+) +(?&lt;cnt&gt;\d+))?$" enabled="y" regexp="y" script="QuaffHandler" />
    <alias match="^acquaff$" enabled="y" regexp="y" script="QuaffHandler" />
    <alias match="caster status" enabled="y" ignore_case="y" script="ShowStatus" />
    <alias match="caster help" enabled="y" ignore_case="y" script="ShowHelp" />
  </aliases>

  <script>
    <![CDATA[
    local last_cast_time = 0
    local is_navigator = false
    local GMCP_ID = "3e7dedbe37e44942dd46d264"
    local debug_mode = (GetVariable("debug_mode") or "0") == "1"

    local Caster = {
        enabled      = (GetVariable("enabled") or "1") == "1",
        is_fighting  = false,
        last_quaff   = 0,
        pause_cast   = false,
        
        cfg = {
            primary      = GetVariable("primary") or "",
            opener       = GetVariable("opener") or "",
            opener_on    = (GetVariable("opener_on") or "0") == "1",
            heal         = GetVariable("heal") or "",
            heal_on      = (GetVariable("heal_on") or "0") == "1",
            consume      = (GetVariable("consume") or "0") == "1",
            quaff_on     = (GetVariable("quaff_on") or "0") == "1",
        },

        vitals = {
            hp = { pct = tonumber(GetVariable("hp_pct")) or 50, cnt = tonumber(GetVariable("hp_cnt")) or 2, item = "big heal", key = "hp", max_key = "maxhp" },
            mn = { pct = tonumber(GetVariable("mn_pct")) or 20, cnt = tonumber(GetVariable("mn_cnt")) or 2, item = "big mana", key = "mana", max_key = "maxmana" },
            mv = { pct = tonumber(GetVariable("mv_pct")) or 20, cnt = tonumber(GetVariable("mv_cnt")) or 2, item = "big move", key = "moves", max_key = "maxmoves" }
        }
    }

    function parse_gmcp(path)
        local res, val = CallPlugin(GMCP_ID, "gmcpval", path)
        if res == 0 and val and val ~= "" then
            local f, err = loadstring("return " .. val)
            if f then return f() end
        end
        return nil
    end

    function Caster.log(msg, color)
        ColourNote("red", "", " >>> ", color or "white", "", msg)
    end

    function Caster.debug(msg)
        if debug_mode then
            ColourNote("darkorange", "", " [Caster Debug] ", "gray", "", msg)
        end
    end

    function ToggleDebug()
        debug_mode = not debug_mode
        SetVariable("debug_mode", debug_mode and "1" or "0")
        Caster.log("Debug Messaging: " .. (debug_mode and "ON" or "OFF"), "cyan")
        SaveState()
    end

    function Caster.heartbeat()
        if not Caster.enabled or not Caster.is_fighting or Caster.pause_cast then return end
        local cooldown = is_navigator and 0.25 or 2.1
        local now = os.clock()

        if (now - last_cast_time) >= cooldown then
            if Caster.cfg.primary ~= "" then
                Execute(Caster.cfg.primary)
                last_cast_time = now
            end
        end
    end

    function Caster.check_vitals()
        local now = os.clock()
        if Caster.pause_cast and (now - Caster.last_quaff) > 3 then
            Caster.pause_cast = false
        end

        if not Caster.cfg.quaff_on or not Caster.enabled or not Caster.is_fighting then return end
        if (now - Caster.last_quaff) < 3 then return end

        local current_vitals = parse_gmcp("char.vitals")
        local max_vitals = parse_gmcp("char.maxstats")
        if not current_vitals or not max_vitals then return end

        for key, data in pairs(Caster.vitals) do
            local cur = tonumber(current_vitals[data.key])
            local max = tonumber(max_vitals[data.max_key])

            if cur and max then
                local current_pct = (cur / max * 100)
                if current_pct < data.pct then
                    Caster.log("Low " .. key:upper() .. "! Quaffing " .. data.cnt .. "x " .. data.item, "yellow")
                    Caster.pause_cast = true
                    for i = 1, data.cnt do
                        Execute("dinv consume " .. data.item)
                    end
                    Caster.last_quaff = now
                    return 
                end
            end
        end
    end

    function QuaffHandler(name, line, wildcards)
        if line == "acquaff" then
            Caster.cfg.quaff_on = not Caster.cfg.quaff_on
            SetVariable("quaff_on", Caster.cfg.quaff_on and "1" or "0")
            Caster.log("Auto-Quaff: " .. (Caster.cfg.quaff_on and "ON" or "OFF"), Caster.cfg.quaff_on and "lime" or "red")
        else
            local t = wildcards.type:lower()
            local pct, cnt = tonumber(wildcards.pct), tonumber(wildcards.cnt)
            Caster.vitals[t].pct, Caster.vitals[t].cnt = pct, cnt
            SetVariable(t .. "_pct", tostring(pct))
            SetVariable(t .. "_cnt", tostring(cnt))
            Caster.log(t:upper() .. " quaff set to " .. pct .. "% (Repeat " .. cnt .. "x)", "cyan")
        end
        SaveState()
    end

    function AliasHandler(name, line, wildcards)
        local input = line:lower()
        local val = wildcards.cmd or ""

        if input:find("^acopen") then
            if val == "" then Caster.cfg.opener_on = not Caster.cfg.opener_on
            else Caster.cfg.opener = val; Caster.cfg.opener_on = true; SetVariable("opener", val) end
            SetVariable("opener_on", Caster.cfg.opener_on and "1" or "0")
            Caster.log("Opener (Start-Combat): " .. (Caster.cfg.opener_on and "ON" or "OFF"), Caster.cfg.opener_on and "lime" or "red")
        elseif input:find("^acheal") then
            if val == "" then Caster.cfg.heal_on = not Caster.cfg.heal_on
            else Caster.cfg.heal = val; Caster.cfg.heal_on = true; SetVariable("heal", val) end
            SetVariable("heal_on", Caster.cfg.heal_on and "1" or "0")
            Caster.log("Recovery (End-Combat): " .. (Caster.cfg.heal_on and "ON" or "OFF"), Caster.cfg.heal_on and "lime" or "red")
        elseif input:find("^acconsume") then
            Caster.cfg.consume = not Caster.cfg.consume
            SetVariable("consume", Caster.cfg.consume and "1" or "0")
            Caster.log("Post-combat 'consume': " .. (Caster.cfg.consume and "ON" or "OFF"), Caster.cfg.consume and "lime" or "red")
        else
            if val == "" then
                Caster.enabled = not Caster.enabled
                SetVariable("enabled", Caster.enabled and "1" or "0")
                Caster.log("Caster System: " .. (Caster.enabled and "ON" or "OFF"), Caster.enabled and "lime" or "red")
            else
                Caster.cfg.primary = val
                SetVariable("primary", val)
                Caster.log("Primary set to: " .. val, "cyan")
            end
        end
        SaveState()
    end

    function ShowStatus(name, line, wildcards)
        local function onoff(b) return b and "ON" or "OFF", b and "lime" or "red" end
        local sys, sys_c = onoff(Caster.enabled)
        local op, op_c = onoff(Caster.cfg.opener_on)
        local he, he_c = onoff(Caster.cfg.heal_on)
        local co, co_c = onoff(Caster.cfg.consume)
        local qu, qu_c = onoff(Caster.cfg.quaff_on)

        ColourNote("silver", "", "--------------------------------------------------")
        ColourNote("cyan", "", " [ CASTER SYSTEM STATUS ] ")
        Note("")
        ColourTell("silver", "", " System Power:   ") ColourNote(sys_c, "", sys)
        ColourTell("silver", "", " Primary Skill:  ") ColourNote("yellow", "", Caster.cfg.primary)
        Note("")
        ColourTell("silver", "", " Opener (Start): ") ColourTell(op_c, "", op) ColourNote("gray", "", " [" .. Caster.cfg.opener .. "]")
        ColourTell("silver", "", " Heal (End):     ") ColourTell(he_c, "", he) ColourNote("gray", "", " [" .. Caster.cfg.heal .. "]")
        ColourTell("silver", "", " Post-Consume:   ") ColourNote(co_c, "", co)
        Note("")
        ColourTell("silver", "", " Auto-Quaff:     ") ColourNote(qu_c, "", qu)
        for _, k in ipairs({"hp", "mn", "mv"}) do
            local v = Caster.vitals[k]
            local color = "lime"
            if v.pct > 70 then color = "green" elseif v.pct < 30 then color = "red" end
            ColourTell("silver", "", string.format("  %-3s Threshold: ", k:upper()))
            ColourTell(color, "", v.pct .. "%")
            ColourNote("silver", "", " (x" .. v.cnt .. " " .. v.item .. ")")
        end
        ColourNote("silver", "", "--------------------------------------------------")
    end

    function ShowHelp(name, line, wildcards)
        ColourNote("silver", "", "--------------------------------------------------")
        ColourNote("cyan", "", " [ AUTO-CASTER GMCP HELP ] ")
        Note("")
        ColourTell("yellow", "", " ac <skill>      ") ColourNote("silver", "", "- Set attack loop.")
        ColourNote("gray", "", "                 Example: ac cast 626  OR  ac backstab;spiral")
        ColourTell("yellow", "", " ac              ") ColourNote("silver", "", "- Toggle main system power")
        Note("")
        ColourTell("lime", "", " acopen <skill>  ") ColourNote("silver", "", "- Fires ONCE at start of combat")
        ColourNote("gray", "", "                 Example: acopen c 8   OR  acopen cast 8")
        ColourTell("lime", "", " acheal <skill>  ") ColourNote("silver", "", "- Fires ONCE at end of combat")
        ColourNote("gray", "", "                 Example: acheal c 108 OR  acheal c 108 heracles")
        ColourNote("silver", "", "                 (Type command alone to toggle ON/OFF)")
        Note("")
        ColourTell("orange", "", " acquaff <type> <%> <count> ") ColourNote("silver", "", "- Set Thresholds")
        ColourNote("gray", "", "                 Types: hp, mn, mv")
        ColourNote("gray", "", "                 Example: acquaff hp 40 2")
        ColourTell("orange", "", " acquaff         ") ColourNote("silver", "", "- Toggle auto-potions (Requires 'dinv')")
        ColourTell("orange", "", " acconsume       ") ColourNote("silver", "", "- Toggle 'consume' command after combat")
        Note("")
        ColourNote("red", "", " IMPORTANT: Auto-Quaff REQUIRES the Aard Inventory plugin")
        ColourNote("red", "", " by Durel. Ensure 'dinv consume' is configured correctly.")
        ColourNote("silver", "", "--------------------------------------------------")
    end

    function OnPluginBroadcast(msg, id, name, text)
        if id ~= GMCP_ID then return end
        if text == "char.vitals" then
            Caster.check_vitals()
            Caster.heartbeat()
        elseif text == "char.status" then
            local status = parse_gmcp("char.status")
            if not status then return end
            local fighting = (status.state == "8")
            if fighting and not Caster.is_fighting then
                if Caster.cfg.opener_on and Caster.cfg.opener ~= "" then Execute(Caster.cfg.opener) end
                last_cast_time = 0
            elseif not fighting and Caster.is_fighting then
                if Caster.cfg.heal_on and Caster.cfg.heal ~= "" then Execute(Caster.cfg.heal) end
                if Caster.cfg.consume then Execute("consume") end
                Caster.pause_cast = false
            end
            Caster.is_fighting = fighting
            local base = parse_gmcp("char.base")
            if base then is_navigator = (base.subclass == "Navigator") end
        end
    end
    Caster.log("V22.0 Final Build. All help-file typos resolved.", "lime")
    ]]>
  </script>
</muclient>