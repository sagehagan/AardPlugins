<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="GMCP_Monitor"
   author="Assistant"
   id="e8a1f2b3c4d5e6f7a8b9c0d1"
   language="Lua"
   purpose="Inspects GMCP data using gmcpval"
   save_state="y"
   date_written="2026-01-25"
   version="1.8"
   >
</plugin>

<aliases>
  <alias match="gm" enabled="y" sequence="100" send_to="12"><send>ToggleMonitor()</send></alias>
  <alias match="gm help" enabled="y" sequence="90" send_to="12"><send>ShowHelp()</send></alias>
  <alias match="^lua (.*)$" enabled="y" regexp="y" sequence="100" send_to="12"><send>InspectGMCP("%1")</send></alias>
</aliases>

<script>
<![CDATA[
local json = require("json")
local monitoring = false
local HANDLER_ID = "3e7dedbe37e44942dd46d264"

function OnPluginInstall()
    -- Colorful, professional single line on load
    ColourNote("cyan", "", "GMCP_Monitor v1.8 initialized. Type ", "yellow", "", "gm help", "cyan", "", " for commands and status.")
    print("[DEBUG] Plugin Loaded. Monitoring default: " .. tostring(monitoring))
end

function ShowHelp()
    print("[DEBUG] ShowHelp called.")
    Note("")
    ColourNote("cyan", "black", "GMCP Monitor Help System")
    ColourNote("silver", "black", "--------------------------------------------------")
    ColourNote("yellow", "black", " gm         ", "white", "black", "- Toggles real-time stream (Default: OFF)")
    ColourNote("yellow", "black", " gm help    ", "white", "black", "- Displays this professional menu")
    ColourNote("yellow", "black", " lua <path> ", "white", "black", "- e.g. lua gmcp.char.vitals or lua char.vitals")
    ColourNote("silver", "black", "--------------------------------------------------")
    Note("")
end

function ToggleMonitor()
    monitoring = not monitoring
    print("[DEBUG] ToggleMonitor event. State: " .. tostring(monitoring))
    local state = monitoring and "ENABLED" or "DISABLED"
    local color = monitoring and "lime" or "red"
    ColourNote("silver", "", "[", "cyan", "", "GMCP_Monitor", "silver", "", "] Monitoring: ", color, "", state)
end

function serialize(t, indent)
    indent = indent or ""
    if type(t) ~= "table" then 
        print(indent .. tostring(t))
        return 
    end
    
    local keys = {}
    for k in pairs(t) do table.insert(keys, k) end
    table.sort(keys)

    for _, k in ipairs(keys) do
        local v = t[k]
        if type(v) == "table" then
            print(indent .. k .. ":")
            serialize(v, indent .. "  ")
        else
            -- Color code values for better professional display
            local val_str = tostring(v)
            local val_color = type(v) == "number" and "lime" or "white"
            Tell(indent .. k .. ": ")
            ColourNote(val_color, "", val_str)
        end
    end
end

function InspectGMCP(path)
    print("[DEBUG] Inspecting: " .. path)
    
    -- Normalize path: remove "gmcp." if it starts with it
    local request_path = path:gsub("^gmcp%.", "")
    
    -- If they just typed 'lua gmcp', they want the root
    if path == "gmcp" then request_path = "" end

    local rc, result = CallPlugin(HANDLER_ID, "gmcpval", request_path)
    
    if rc == 0 and result and result ~= "" then
        local success, data = pcall(json.decode, result)
        ColourNote("yellow", "", "--- GMCP Data: " .. path .. " ---")
        if success then
            serialize(data, " ")
        else
            print(" " .. tostring(result))
        end
    else
        print("[DEBUG] Handler found no data for: " .. request_path)
        ColourNote("orange", "", "No data found for path: " .. path)
    end
end

function OnPluginBroadcast(msg, id, name, text)
    if id == HANDLER_ID and monitoring then
        ColourNote("cyan", "", "[GMCP] ", "white", "", text)
    end
end
]]>
</script>
</muclient>