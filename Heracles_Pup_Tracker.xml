<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
  name="Heracles_Pup_Tracker"
  author="Heracles"
  id="87de24dc0b84faae4729ffb8"
  language="Lua"
  purpose="Automatic Pup Tracking"
  save_state="y"
  date_written="2026-01-23"
  requires="5.06"
  version="11.3"
  >
</plugin>

<timers>
  <timer name="tmPulse" enabled="y" second="1" script="TmrPulse" />
</timers>

<aliases>
  <alias match="^pt chan (.+)$" script="tracker_settings" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt log (.+)$" script="tracker_log_settings" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt help$" script="pt_help" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt report$" script="ToggleReport" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt list (\d+)$" script="ShowDailyHistory" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt list date (.+) to (.+)$" script="ShowDailyRange" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt summary (\d+)$" script="ShowTotalHistory" enabled="y" regexp="y" sequence="100" />
  <alias match="^pt summary date (.+) to (.+)$" script="ShowRangeHistory" enabled="y" regexp="y" sequence="100" />
</aliases>

<triggers>
  <trigger enabled="y" match="Congratulations, *. You have increased your powerups to *." script="TrgPup" sequence="100" />
  <trigger enabled="y" match="You gain * trains." name="pupgains" script="TrgPupGains" group="trgLevelInfo" sequence="100" />
  <trigger enabled="y" regexp="y" match="^Lucky! You gain an extra (\d) training sessions?!$" name="bonusgains" script="TrgPupGains" group="trgLevelInfo" sequence="100" />
  <trigger enabled="y" regexp="y" match="^You gain (.*) extra(?: trains)? daily blessing bonus.$" name="blessingtrains" script="TrgPupGains" group="trgLevelInfo" sequence="100" />
  <trigger enabled="y" regexp="y" match="^$" name="trgFinish" script="TrgFinish" sequence="100" />
  <trigger enabled="y" regexp="y" match="^You get ([\d,]+) gold coins (.+) corpse of (.+)\.$" script="TrgGold" sequence="100" />
  <trigger enabled="y" regexp="y" match="^.*? crumbles into ([\d,]+) gold pieces\.$" script="TrgGold" sequence="100" />
  <trigger enabled="y" regexp="y" match="^You receive (\d+)(?:\+(\d+))?(?:\+(\d+))? experience points?\.$" name="trgMobExp" script="TrgExp" sequence="100" />
</triggers>

<script>
<![CDATA[
require "serialize"

local history = {}
local today_times = {}
local daily_archive = {}
local rep_chan = "print"
local log_tab = ""
local t_date = ""
local t_trains, t_pups, t_gold = 0, 0, 0
local last_pup_time = 0

local report_active = false
local report_start_time = 0
local fiveMinStats = { pups = 0, trains = 0, gold = 0, times = {} }

local color_map = {
    ["@R"] = "@R", ["@G"] = "@G", ["@B"] = "@B", 
    ["@Y"] = "@Y", ["@C"] = "@C", ["@W"] = "@W", ["@D"] = "@D"
}

local month_map = {
    ["01"]="Jan", ["02"]="Feb", ["03"]="Mar", ["04"]="Apr", ["05"]="May", ["06"]="Jun",
    ["07"]="Jul", ["08"]="Aug", ["09"]="Sep", ["10"]="Oct", ["11"]="Nov", ["12"]="Dec"
}

function CleanDate(dStr)
    if not dStr then return "" end
    if dStr:match("^%d%d %a%a%a %d%d%d%d$") then return dStr end
    local d, m, y = dStr:match("^(%d%d) (%d%d) (%d%d%d%d)$")
    if d and m and y and month_map[m] then
        return string.format("%s %s %s", d, month_map[m], y)
    end
    return dStr
end

function GetESTDate()
    local utc_time = os.time(os.date("!*t"))
    local est_offset = 5 * 3600
    return os.date("%d %b %Y", utc_time - est_offset)
end

function OnPluginInstall()
    t_date = GetESTDate()
    t_trains = tonumber(GetVariable("today_trains")) or 0
    t_pups = tonumber(GetVariable("today_pups")) or 0
    t_gold = tonumber(GetVariable("today_gold")) or 0
    rep_chan = GetVariable("repchan") or "print"
    log_tab = GetVariable("log_tab") or ""

    local h_var = GetVariable("history_table")
    if h_var and h_var ~= "" then history = loadstring("return " .. h_var)() or {} end
    local t_var = GetVariable("today_times_table")
    if t_var and t_var ~= "" then today_times = loadstring("return " .. t_var)() or {} end
    local a_var = GetVariable("daily_archive")
    if a_var and a_var ~= "" then daily_archive = loadstring("return " .. a_var)() or {} end

    last_pup_time = GetInfo(304)
    AnsiNote("@R[ @WHeracles @R] @DPup Tracker Loaded. Type @Cpt help @Dfor commands")
    return nil
end

function StylesToColours(str)
    return str:gsub("(@[RGBYCW D])", function(code)
        return color_map[code] or "@W"
    end)
end

function AnsiNote(str)
    local colors = {
        ["@R"] = "red", ["@G"] = "lime", ["@B"] = "blue", 
        ["@Y"] = "yellow", ["@C"] = "cyan", ["@W"] = "white", ["@D"] = "gray"
    }
    local current = 1
    while current <= #str do
        local start, stop, code = str:find("(@[RGBYCW D])", current)
        if start then
            if start > current then ColourTell("white", "", str:sub(current, start - 1)) end
            local next_tag = str:find("@[RGBYCW D]", stop + 1)
            local seg_end = (next_tag and next_tag - 1) or #str
            ColourTell(colors[code] or "white", "", str:sub(stop + 1, seg_end))
            current = seg_end + 1
        else
            ColourTell("white", "", str:sub(current))
            break
        end
    end
    Note("")
    return nil
end

local newPup = { trains = 0, bonus = 0, kills = 0, gold = 0 }

function TrgPup(name, line, w)
    newPup.finishTime = GetInfo(304)
    EnableTriggerGroup("trgLevelInfo", true)
    EnableTrigger("trgFinish", true)
    return nil
end

function TrgPupGains(name, line, w)
    local amt = tonumber(w[1]) or 0
    if name == "pupgains" then newPup.trains = amt else newPup.bonus = newPup.bonus + amt end
    return nil
end

function TrgGold(name, line, w)
    local g = tonumber((string.gsub(w[1], ",", ""))) or 0
    newPup.gold = (newPup.gold or 0) + g
    t_gold = (t_gold or 0) + g
    if report_active then fiveMinStats.gold = fiveMinStats.gold + g end
    return nil
end

function TrgExp(name, line, w)
    newPup.kills = (newPup.kills or 0) + 1
    return nil
end

function TrgFinish(name, line, w)
    if (newPup.trains or 0) > 0 then
        EnableTriggerGroup("trgLevelInfo", false)
        EnableTrigger("trgFinish", false)
        local pTime = math.max(0, newPup.finishTime - last_pup_time)
        local totalTrains = newPup.trains + newPup.bonus
        if pTime <= 60 then
            table.insert(history, pTime)
            if #history > 10 then table.remove(history, 1) end
            table.insert(today_times, pTime)
            if report_active then table.insert(fiveMinStats.times, pTime) end
        end
        if report_active then
            fiveMinStats.pups = fiveMinStats.pups + 1
            fiveMinStats.trains = fiveMinStats.trains + totalTrains
        end
        t_pups = t_pups + 1; t_trains = t_trains + totalTrains
        BroadcastPup(pTime, totalTrains)
        last_pup_time = GetInfo(304)
        newPup = { trains = 0, bonus = 0, kills = 0, gold = 0 }
        SaveState()
    end
    return nil
end

function TmrPulse(name)
    local currDate = GetESTDate()
    if t_date ~= currDate then
        local sTime = 0; for _,v in ipairs(today_times) do sTime = sTime + v end
        local avgToday = (#today_times > 0) and (sTime / #today_times) or 0
        local final_report = string.format("@R[@WFINAL SUMMARY: %s@R] @DPups: @W%s @R| @DTrains: @W%s @R| @DGold: @Y%s @R| @DAvg: @W%s", 
                             t_date, CommaValue(t_pups), CommaValue(t_trains), FormatGold(t_gold), FormatSeconds(avgToday))
        if log_tab ~= "" then CallPlugin("b555825a4a5700c35fa80780", "storeFromOutside", StylesToColours(final_report), log_tab) end
        table.insert(daily_archive, { date = t_date, pups = t_pups, trains = t_trains, gold = t_gold, avg = avgToday, time_count = #today_times })
        if #daily_archive > 30 then table.remove(daily_archive, 1) end
        t_date = currDate; t_trains, t_pups, t_gold = 0, 0, 0
        history, today_times = {}, {}; SaveState()
    end
    if report_active and os.time() - report_start_time >= 300 then ExecuteReport() end
    return nil
end

function GetFullSet()
    local full = {}
    for _,v in ipairs(daily_archive) do table.insert(full, v) end
    local sTime = 0; for _,v in ipairs(today_times) do sTime = sTime + v end
    local avgToday = (#today_times > 0) and (sTime / #today_times) or 0
    table.insert(full, { date = t_date, pups = t_pups, trains = t_trains, gold = t_gold, avg = avgToday, time_count = #today_times })
    return full
end

function ShowDailyHistory(name, line, wildcards)
    local full = GetFullSet()
    local count = math.min(tonumber(wildcards[1]), #full)
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote("@W                          DAILY BREAKDOWN (LAST " .. count .. " DAYS)           ")
    AnsiNote("@R--------------------------------------------------------------------------------")
    for i = #full, #full - count + 1, -1 do
        local d = full[i]
        AnsiNote(string.format("@C%s @R| @DPups: @W%s @R| @DTrains: @W%s @R| @DGold: @Y%s @R| @DAvg: @W%s", 
                 d.date, CommaValue(d.pups), CommaValue(d.trains), FormatGold(d.gold), FormatSeconds(d.avg or 0)))
    end
    AnsiNote("@R--------------------------------------------------------------------------------")
end

function ShowDailyRange(name, line, wildcards)
    local sDate, eDate = CleanDate(wildcards[1]), CleanDate(wildcards[2])
    local full, results, inRange = GetFullSet(), {}, false
    for _, d in ipairs(full) do
        local d_clean = CleanDate(d.date)
        if d_clean == sDate then inRange = true end
        if inRange then table.insert(results, d) end
        if d_clean == eDate then inRange = false end
    end
    AnsiNote("@R--------------------------------------------------------------------------------")
    for i = #results, 1, -1 do
        local d = results[i]
        AnsiNote(string.format("@C%s @R| @DPups: @W%s @R| @DTrains: @W%s @R| @DGold: @Y%s @R| @DAvg: @W%s", 
                 d.date, CommaValue(d.pups), CommaValue(d.trains), FormatGold(d.gold), FormatSeconds(d.avg or 0)))
    end
    AnsiNote("@R--------------------------------------------------------------------------------")
end

function ShowTotalHistory(name, line, wildcards)
    local full = GetFullSet()
    local count = math.min(tonumber(wildcards[1]), #full)
    local sPups, sTrains, sGold, totalSeconds, totalCount = 0, 0, 0, 0, 0
    for i = #full, #full - count + 1, -1 do
        local d = full[i]
        sPups, sTrains, sGold = sPups + d.pups, sTrains + d.trains, sGold + d.gold
        totalSeconds = totalSeconds + ((d.avg or 0) * (d.time_count or 0)); totalCount = totalCount + (d.time_count or 0)
    end
    local grandAvg = (totalCount > 0) and (totalSeconds / totalCount) or 0
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote(string.format("@DPups: @W%s @R| @DTrains: @W%s @R| @DGold: @Y%s @R| @DAvg: @W%s", 
             CommaValue(sPups), CommaValue(sTrains), FormatGold(sGold), FormatSeconds(grandAvg)))
    AnsiNote("@R--------------------------------------------------------------------------------")
end

function ShowRangeHistory(name, line, wildcards)
    local sDate, eDate = CleanDate(wildcards[1]), CleanDate(wildcards[2])
    local full, sPups, sTrains, sGold, totalSeconds, totalCount, inRange = GetFullSet(), 0, 0, 0, 0, 0, false
    for _, d in ipairs(full) do
        local d_clean = CleanDate(d.date)
        if d_clean == sDate then inRange = true end
        if inRange then
            sPups, sTrains, sGold = sPups + d.pups, sTrains + d.trains, sGold + d.gold
            totalSeconds = totalSeconds + ((d.avg or 0) * (d.time_count or 0)); totalCount = totalCount + (d.time_count or 0)
        end
        if d_clean == eDate then inRange = false end
    end
    local grandAvg = (totalCount > 0) and (totalSeconds / totalCount) or 0
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote(string.format("@DPups: @W%s @R| @DTrains: @W%s @R| @DGold: @Y%s @R| @DAvg: @W%s", 
             CommaValue(sPups), CommaValue(sTrains), FormatGold(sGold), FormatSeconds(grandAvg)))
    AnsiNote("@R--------------------------------------------------------------------------------")
end

function ToggleReport(name, line, wildcards)
    if not report_active then
        fiveMinStats = { pups = 0, trains = 0, gold = 0, times = {} }
        report_start_time = os.time(); report_active = true
        AnsiNote("@R[ @WHeracles @R] @G5-Min Report: @WSTARTED@D")
    else
        report_active = false
        AnsiNote("@R[ @WHeracles @R] @G5-Min Report: @RCANCELED@D")
    end
    return nil
end

function ExecuteReport()
    local sum = 0; for _, v in ipairs(fiveMinStats.times) do sum = sum + v end
    local avg = (#fiveMinStats.times > 0) and (sum / #fiveMinStats.times) or 0
    local color_body = string.format("@R[@W5-MIN SUMMARY@R] @DPups: @W%d @R| @DTrains: @W%d @R| @DGold: @Y%s @R| @DAvg: @W%ds", 
                       fiveMinStats.pups, fiveMinStats.trains, FormatGold(fiveMinStats.gold), math.floor(avg))
    if rep_chan == "print" then
        AnsiNote("@D--------------------------------------------------------------------------------")
        AnsiNote(color_body)
        AnsiNote("@D--------------------------------------------------------------------------------")
    elseif rep_chan ~= "none" then
        Execute(rep_chan .. " " .. string.format("[5-MIN SUMMARY] Pups: %d | Trains: %d | Gold: %s | Avg: %ds", 
                     fiveMinStats.pups, fiveMinStats.trains, FormatGold(fiveMinStats.gold), math.floor(avg)))
    end
    if log_tab ~= "" then CallPlugin("b555825a4a5700c35fa80780", "storeFromOutside", StylesToColours(color_body), log_tab) end
    fiveMinStats = { pups = 0, trains = 0, gold = 0, times = {} }
    report_start_time = os.time()
    return nil
end

function CommaValue(amount)
    local formatted = tostring(amount); while true do
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", '%1,%2')
        if (k==0) then break end
    end
    return formatted
end

function FormatGold(val)
    local amount = tonumber(val) or 0
    if amount >= 1000000 then return string.format("%.2fM", amount / 1000000)
    elseif amount >= 1000 then return string.format("%.1fK", amount / 1000)
    else return tostring(amount) end
end

function FormatSeconds(s)
    s = math.floor(tonumber(s) or 0); local m = math.floor(s / 60); local sec = s % 60
    if m > 0 then return m .. "m " .. sec .. "s" end
    return sec .. "s"
end

function BroadcastPup(pTime, totalTrains)
    local s1 = 0; for _,v in ipairs(history) do s1=s1+v end
    local avg10 = (#history > 0) and (s1/#history) or 0
    local s2 = 0; for _,v in ipairs(today_times) do s2 = s2 + v end
    local avgToday = (#today_times > 0) and (s2 / #today_times) or 0
    local color_msg = string.format("@R[@DPup: @W%s@R] [@DTime: @W%s@R] [@DAvg: @W%s @DToday: @W%s@R] [@DKills: @W%d@R] [@DTrains: @W%d @DToday: @W%s@R] [@DGold: @Y%s @DToday: @Y%s@R]", 
                      CommaValue(t_pups), FormatSeconds(pTime), FormatSeconds(avg10), FormatSeconds(avgToday), 
                      newPup.kills or 0, totalTrains, CommaValue(t_trains), FormatGold(newPup.gold or 0), FormatGold(t_gold))
    if rep_chan == "print" then AnsiNote(color_msg)
    elseif rep_chan ~= "none" then Execute(rep_chan .. " " .. color_msg:gsub("@[RGBYCW D]", "")) end
    if log_tab ~= "" then CallPlugin("b555825a4a5700c35fa80780", "storeFromOutside", StylesToColours(color_msg), log_tab) end
    return nil
end

function tracker_settings(name, line, wildcards)
    rep_chan = wildcards[1]; SetVariable("repchan", rep_chan)
    AnsiNote("@R[ @WHeracles @R] @DOutput Channel: @W" .. rep_chan)
    return nil
end

function tracker_log_settings(name, line, wildcards)
    log_tab = wildcards[1]; if log_tab == "off" then log_tab = "" end
    SetVariable("log_tab", log_tab)
    AnsiNote("@R[ @WHeracles @R] @DLogging to Tab: @W" .. (log_tab == "" and "OFF" or log_tab))
    return nil
end

function OnPluginSaveState()
    SetVariable("today_date", t_date); SetVariable("today_trains", tostring(t_trains))
    SetVariable("today_pups", tostring(t_pups)); SetVariable("today_gold", tostring(t_gold))
    SetVariable("repchan", rep_chan); SetVariable("log_tab", log_tab)
    SetVariable("history_table", serialize.save_simple(history))
    SetVariable("today_times_table", serialize.save_simple(today_times))
    SetVariable("daily_archive", serialize.save_simple(daily_archive))
    return nil
end

function pt_help()
    AnsiNote(" ")
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote("@W                             HERACLES PUP TRACKER                               ")
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote("  @WSYSTEM COMMANDS")
    AnsiNote("  @Cpt chan <channel>           @D: Set output (Ex: @Cgtell@D, @Cclantalk@D, @Cprint@D)")
    AnsiNote("  @Cpt log <tab_name>           @D: Redirect output to Comm Log tab (Ex: @CPups@D)")
    AnsiNote("  @Cpt log off                  @D: Disables tab redirection")
    AnsiNote("  @Cpt report                   @D: Toggles a 5-minute stat collection window")
    AnsiNote("  @Cpt help                     @D: Displays this menu")
    AnsiNote(" ")
    AnsiNote("  @WREPORTING COMMANDS")
    AnsiNote("  @Cpt list <#>                 @D: Breakdown for last X days. Ex: @Wpt list 7")
    AnsiNote("  @Cpt list date <d1> to <d2>   @D: Range Ex: @Wpt list date 1 Jan 2026 to 10 Jan 2026")
    AnsiNote("  @Cpt summary <#>              @D: Total for last X days. Ex: @Wpt summary 30")
    AnsiNote("  @Cpt summary date <d1> to <d2>@D: Range Ex: @Wpt summary date 1 Jan 2026 to 10 Jan 2026")
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote("  @WCURRENT STATUS:")
    AnsiNote("  @DSystem Date: @W" .. t_date)
    AnsiNote("  @DOutput Chan: @W" .. rep_chan .. " @D| Logging Tab: @W" .. (log_tab == "" and "OFF" or log_tab))
    AnsiNote("@R--------------------------------------------------------------------------------")
    AnsiNote(" ")
    return nil
end
]]>
</script>
</muclient>